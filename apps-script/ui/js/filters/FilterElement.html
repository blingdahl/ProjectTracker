class FilterElement {
  constructor(cssClass, textCallback, allValuesText, emptyValues, emptyText, paramName, allValues, changeCallback) {
    this.cssClass = cssClass;
    this.textCallback = textCallback;
    this.allValuesText = allValuesText;
    this.emptyValues = emptyValues;
    this.emptyText = emptyText;
    this.paramName = paramName;
    this.values = [];
    this.changeCallback = changeCallback;
    this.allValues = allValues;
    this.jq = $('<span />').addClass('filterElement').addClass(cssClass);
    this.textJq = $('<span />').addClass('filterText');
    this.jq.append(this.textJq).append($('<span>&#9660;</span>').addClass('arrow'));
    this.getFromUrl();
  }
  
  // Called once per table load
  attachClickHandler(ancestorJq) {
    ancestorJq.on('click', '.' + this.cssClass, this.textClicked.bind(this));
  }
  
  valuesToText() {
    if (this.values.length == 0) {
      return this.emptyText;
    }
    let textParts = [];
    this.values.forEach(value => textParts.push(this.textCallback(value)));
    return textParts.join(', ');
  }
  
  updateTextJq() {
    let text;
    if (this.values.length == 0) {
      text = this.emptyText;
    } else if (this.values.length === this.allValues.length) {
      text = this.allValuesText;
    } else {
      let textParts = [];
      this.values.forEach(value => textParts.push(this.textCallback(value)));
      text = textParts.join(', ');
    }
    this.textJq.text(text);
    this.jq.show();
  }
  
  setValues(newValues) {
    this.values = newValues;
    this.updateTextJq();
    this.changeCallback(newValues);
  }
  
  getValues() {
    return this.values || this.emptyValues;
  }
  
  textClicked(e) {
    let input = new MultiOptionInputMaker(this.allValues, this.textCallback).makeElement(this.getValues(),
        newValues => {
          this.setValues(newValues);
          this.updateUrl();
        },
        () => this.jq.show());
    this.jq.parent().append(input);
    this.jq.hide();
  }
  
  appendTo(parentJq) {
    this.updateTextJq();
    parentJq.append(this.jq);
    this.attachClickHandler(parentJq);
  }
  
  getFromUrl() {
    Hash.withParam(this.paramName, paramValue => {
      if (paramValue) {
        this.setValues(paramValue.split(','));
      }
    });
  }
  
  updateUrl() {
    Hash.setParam(this.paramName, this.getValues().join(','));
  }
}
