class FilterElement {
  constructor(cssClass, textCallback, allValuesText, emptyValues, emptyText, paramName,
      allValues, changeCallback) {
    this.cssClass = cssClass;
    this.textCallback = textCallback;
    this.allValuesText = allValuesText;
    this.emptyValues = emptyValues;
    this.emptyText = emptyText;
    this.paramName = paramName;
    this.values = [];
    this.changeCallback = changeCallback;
    this.allValues = allValues;
    this.jq = $('<span />').addClass('filterElement').addClass(cssClass);
    this.textJq = $('<span />').addClass('filterText');
    this.jq.append(this.textJq).append($('<span>&#9660;</span>').addClass('arrow'));
    this.getFromUrl();
    this.additionalValueSets = [];
    this.loadValueSets();
  }
  
  // Called once per table load
  attachClickHandler(ancestorJq) {
    ancestorJq.on('click', '.' + this.cssClass, this.textClicked.bind(this));
  }
  
  valuesToText() {
    if (this.values.length == 0) {
      return this.emptyText;
    }
    let textParts = [];
    this.values.forEach(value => textParts.push(this.textCallback(value)));
    return textParts.join(', ');
  }
  
  updateTextJq() {
    let text;
    if (this.values.length == 0) {
      text = this.emptyText;
    } else if (this.values.length === this.allValues.length) {
      text = this.allValuesText;
    } else {
      let textParts = [];
      this.values.forEach(value => textParts.push(this.textCallback(value)));
      text = textParts.join(', ');
    }
    this.textJq.text(text);
    this.jq.show();
  }
  
  setValues(newValues) {
    this.values = newValues;
    this.updateTextJq();
    this.changeCallback(newValues);
  }
  
  getValues() {
    return this.values.length > 0 ? this.values : this.emptyValues;
  }
  
  handleValueSetsJson(json) {
    if (json) {
      this.additionalValueSets = MultiOptionInputValueSet.fromJson(json);
    }
  }
  
  loadValueSets() {
    return new RpcConfig('Preferences_getValueSetsJsonForFilter',
                         runner => runner.Preferences_getValueSetsJsonForFilter(this.paramName)).
        logAll().
        callRpc().
        then(msg => this.handleValueSetsJson(msg));
  }
  
  saveValueSets() {
    return new RpcConfig('Preferences_setValueSetsJsonForFilter',
                         runner => runner.Preferences_setValueSetsJsonForFilter(this.paramName, MultiOptionInputValueSet.toJson(this.additionalValueSets))).
        logAll().
        callRpc();
  }
  
  addValueSet(values) {
    let text = window.prompt('Name');
    if (text) {
      this.additionalValueSets.push(new MultiOptionInputValueSet(text, values, true));
    }
    this.saveValueSets();
  }
  
  removeValueSet(text, values) {
    let newValueSets = [];
    this.additionalValueSets.forEach(valueSet => {
      if (valueSet.text !== text) {
        // TODO(lindahl) Compare values as well
        newValueSets.push(valueSet);
      }
    });
    this.additionalValueSets = newValueSets;
    this.saveValueSets();
  }
  
  valueSets() {
    return [new MultiOptionInputValueSet(this.allValuesText, this.allValues, false)].
         concat(this.additionalValueSets);
  }
  
  textClicked(e) {
    let input = new MultiOptionInputMaker(this.allValues, this.textCallback,
                                          this.valueSets()).
        makeElement(this.getValues(),
          newValues => {
            this.setValues(newValues);
            this.updateUrl();
          },
          () => this.jq.show(),
          values => {
            this.addValueSet(values);
          },
          (text, values) => {
            this.removeValueSet(text, values);
          });
    this.jq.parent().append(input);
    this.jq.hide();
  }
  
  appendTo(parentJq) {
    this.updateTextJq();
    parentJq.append(this.jq);
    this.attachClickHandler(parentJq);
  }
  
  getFromUrl() {
    Hash.withParam(this.paramName, paramValue => {
      if (paramValue) {
        this.setValues(paramValue.split(','));
      }
    });
  }
  
  updateUrl() {
    Hash.setParam(this.paramName, this.getValues().join(','));
  }
}
