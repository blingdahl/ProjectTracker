class FilterElement {
  constructor(cssClass, textCallback, allValuesText, emptyValues, emptyText, storageKey, allValues, changeCallback) {
    this.cssClass = cssClass;
    this.textCallback = textCallback;
    this.allValuesText = allValuesText;
    this.emptyValues = emptyValues;
    this.emptyText = emptyText;
    this.storageKey = storageKey;
    this.values = FilterElement.saved(storageKey, []);
    this.changeCallback = changeCallback;
    this.allValues = allValues;
    this.jq = $('<span />').addClass('filterElement').addClass(cssClass);
    this.textJq = $('<span />').
        addClass('filterText');
    this.jq.append(this.textJq).append($('<span>&#9660;</span>').addClass('arrow'));
  }
  
  // Called once per table load
  attachClickHandler(ancestorJq) {
    ancestorJq.on('click', '.' + this.cssClass, this.textClicked.bind(this));
  }
  
  valuesToText() {
    if (this.values.length == 0) {
      return this.emptyText;
    }
    let textParts = [];
    this.values.forEach(value => textParts.push(this.textCallback(value)));
    return textParts.join(', ');
  }
  
  updateTextJq() {
    let text;
    if (this.values.length == 0) {
      text = this.emptyText;
    } else if (this.values.length === this.allValues.length) {
      text = this.allValuesText;
    } else {
      let textParts = [];
      this.values.forEach(value => textParts.push(this.textCallback(value)));
      text = textParts.join(', ');
    }
    this.textJq.text(text);
    this.jq.show();
  }
  
  textClicked(e) {
    let input = new MultiOptionInputMaker(this.allValues, this.textCallback).makeElement(this.getValues(),
        newValues => {
          this.values = newValues;
          this.updateTextJq();
          FilterElement.save(this.storageKey, newValues);
          this.changeCallback(newValues);
        },
        () => this.jq.show());
    this.jq.parent().append(input);
    this.jq.hide();
  }
  
  appendTo(parentJq) {
    this.updateTextJq();
    parentJq.append(this.jq);
    this.attachClickHandler(parentJq);
  }
  
  getValues() {
    return this.values || this.emptyValues;
  }
  
  static saved(storageKey, defaultValue) {
    let str = sessionStorage.getItem(storageKey);
    if (!str) {
      return defaultValue;
    }
    return str.split(',');
  }
  
  static save(storageKey, values) {
    sessionStorage.setItem(storageKey, values.join(','));
  }
}
