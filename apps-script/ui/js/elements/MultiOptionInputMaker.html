class MultiOptionInputMaker {
  constructor(allValues, textCallback) {
    this.allValues = allValues;
    this.textCallback = textCallback;
  }
  
  makeElement(currValues, changeCallback, cancelCallback) {
    let input = new MultiOptionInput(this.allValues,
                                this.textCallback,
                                currValues,
                                changeCallback,
                                cancelCallback);
    return input.makeElement();
  }
}

class MultiOptionInput {
  constructor(allValues, textCallback, currValues, changeCallback, cancelCallback) {
    this.allValues = allValues;
    this.textCallback = textCallback;
    this.currValues = currValues;
    this.changeCallback = changeCallback;
    this.cancelCallback = cancelCallback;
  }
  
  apply() {
    let newValues = [];
    this.optionsJq.find('[data-selected="true"]').each((index, elt) => {
      let optionJq = $(elt);
      newValues.push(optionJq.attr('data-value'));
    });
    this.optionsJq.remove();
    this.changeCallback(newValues);
  }
  
  clear() {
    this.optionsJq.find('.option').attr('data-selected', 'false');
  }
  
  selectAll() {
    this.optionsJq.find('.option').attr('data-selected', 'true');
  }
  
  cancel() {
    this.optionsJq.remove();
    this.cancelCallback();
  }
  
  selectOnly(optionJq) {
    this.optionsJq.find('.option').attr('data-selected', 'false');
    optionJq.attr('data-selected', 'true');
    this.apply();
  }
  
  toggleOption(optionJq) {
    if (optionJq.attr('data-selected') == 'true') {
      optionJq.attr('data-selected', 'false');
    } else {
      optionJq.attr('data-selected', 'true');
    }
  }
  
  makeElement() {
    this.optionsJq = $('<div />').addClass('multiOptionPicker');
    for (var i = 0; i != this.allValues.length; i++) {
      let value = this.allValues[i];
      let text = this.textCallback(value);
      let onlyJq = MultiOptionInput.ONLY_JQ.clone();
      let optionJq = $('<div />').
          attr('data-value', value).
          attr('data-text', text).
          addClass('option').
          append(MultiOptionInput.CHECK_JQ.clone()).
          append($('<span />').text(text).addClass('text')).
          append(' (').append(onlyJq).append(')');
      optionJq.onClick(event => this.toggleOption(optionJq));
      onlyJq.onClick(event => this.selectOnly(optionJq));
      if (this.currValues.some(currValue => value == currValue)) {
        optionJq.attr('data-selected', 'true');
      }
      this.optionsJq.append(optionJq);
    }
    this.optionsJq.append(new MultiOptionInputButtonBar([
       {text: 'Apply', callback: this.apply.bind(this)},
       {text: 'Clear', callback: this.clear.bind(this)},
       {text: 'All', callback: this.selectAll.bind(this)},
       {text: 'Cancel', callback: this.cancel.bind(this)}]).makeElement());
    return this.optionsJq;
  }
}

class MultiOptionInputButtonBar {
  constructor(buttons) {
    this.buttons = buttons;
  }
  
  makeElement() {
    let buttonsJq = $('<div />').addClass('buttons');
    for (let i = 0; i != this.buttons.length; i++) {
      if (i != 0) {
        buttonsJq.append($('<span />').addClass('betweenButtons'));
      }
      let button = this.buttons[i];
      buttonsJq.append($('<span />').text(button.text).addClass('button').onClick(button.callback));
    }
    return buttonsJq;
  }
}

MultiOptionInput.CHECK_JQ = $('<span>&check;</span>').addClass('check');
MultiOptionInput.ONLY_JQ = $('<span />').text('Only').addClass('only');
