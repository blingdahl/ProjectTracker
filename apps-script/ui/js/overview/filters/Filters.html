class Filters {
  constructor(priority, status, sheetId) {
    this.priority = priority;
    this.status = status;
    this.sheetId = sheetId;
  }
  
  matchesPriority(rowPriority) {
    return !this.priority || this.priority == rowPriority;
  }
  
  matchesStatus(rowStatus) {
    return !this.status || this.status == rowStatus;
  }
  
  matchesSheetId(rowSheetId) {
    return !this.sheetId || this.sheetId == rowSheetId;
  }
  
  matches(rowPriority, rowStatus, rowSheetId) {
    return this.matchesPriority(rowPriority) &&
        this.matchesStatus(rowStatus) &&
        this.matchesSheetId(rowSheetId);
  }
}

class FilterBar {
  constructor(jq, hideColumnsCallback, applyFiltersCallback) {
    this.jq = jq;
    this.hideColumnsCallback = hideColumnsCallback;
    this.applyFiltersCallback = applyFiltersCallback;
  }
  
  getPriorityFilterElement() {
    return this.jq.find('.priorityFilter');
  }
  
  getStatusFilterElement() {
    return this.jq.find('.statusFilter');
  }
  
  getSheetFilterElement() {
    return this.jq.find('.sheetFilter');
  }
  
  getFilterElements() {
    return this.jq.find('.filter');
  }
  
  getShowColumnElements() {
    return this.jq.find('.showColumn');
  }
  
  populateFilter(filterElement, values, emptyKey, emptyName) {
    values.forEach(value => filterElement.append($('<option />').attr('value', value || emptyKey).text(value || emptyName)));
  }
  
  populateSheetFilter(filterElement, sheetInfos) {
    sheetInfos.sort((a, b) => a.sheetName > b.sheetName ? 1 : a.sheetName != b.sheetName ? -1 : 0);
    sheetInfos.forEach(sheetInfo => filterElement.append($('<option />').attr('value', sheetInfo.sheetId).text(sheetInfo.sheetName)));
  }
  
  getFilters() {
    return new Filters(this.getPriorityFilterElement().val(),
                       this.getStatusFilterElement().val(),
                       this.getSheetFilterElement().val());
  }
  
  hideColumnStorageKey(columnKey) {
    return 'hide_' + columnKey;
  }
  
  saveHiddenColumns() {
    this.getShowColumnElements().each((idx, elt) => {
      let jq = $(elt);
      var columnKey = jq.attr('data-key');
      sessionStorage.setItem(this.hideColumnStorageKey(columnKey), String(!jq.is(':checked')));
    });
  }
  
  getHiddenColumns() {
    let hiddenColumns = [];
    this.getShowColumnElements().each((index, elt) => {
      let jq = $(elt);
      if (!jq.is(':checked')) {
        hiddenColumns.push(jq.attr('data-key'));
      }
    });
    return hiddenColumns;
  }
  
  applyHideColumns() {
    this.hideColumnsCallback(this.getHiddenColumns());
    this.saveHiddenColumns();
  }

  init() {
    this.populateFilter(this.getPriorityFilterElement(), GlobalController.PRIORITIES, OverviewController.NO_PRIORITY_KEY, OverviewController.NO_PRIORITY_TEXT);
    this.populateFilter(this.getStatusFilterElement(), GlobalController.STATUSES, OverviewController.NO_STATUS_KEY, OverviewController.NO_STATUS_TEXT);
    this.populateSheetFilter(this.getSheetFilterElement(), SheetController.getSheetInfos());
    this.getFilterElements().change(() => this.applyFiltersCallback(this.getFilters()));
    this.initHiddenColumns();
  }
  
  initHiddenColumns() {
    this.getShowColumnElements().each((idx, elt) => {
      let jq = $(elt);
      var dataKey = jq.attr('data-key');
      let checked = sessionStorage.getItem(this.hideColumnStorageKey(dataKey)) === 'false';
      if (checked) {
        jq.attr('checked', true);
      }
    });
    this.getShowColumnElements().change(this.applyHideColumns.bind(this));
  }
}
