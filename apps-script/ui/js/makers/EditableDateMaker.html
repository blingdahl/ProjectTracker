class EditableDateMaker {
  constructor(cssClass, valueCallback, changeCallback, emptyText) {
    this.cssClass = cssClass;
    this.valueCallback = valueCallback;
    this.changeCallback = changeCallback;
    this.emptyText = emptyText;
  }
  
  // Called once per table load
  attachClickHandler(ancestorJq) {
    ancestorJq.on('click', '.' + this.cssClass, this.linkClicked.bind(this));
  }
  
  makeElement(rowData) {
    let link = $('<a />');
    link.text(this.valueCallback(rowData) || this.emptyText);
    link.addClass(this.cssClass);
    link.addClass('editableField');
    link.attr('data-value', this.valueCallback(rowData));
    return link;
  }
  
  linkClicked(e) {
    var link = $(e.currentTarget);
    let input = this.makeInput(link.attr('data-value'), link);
    link.parent().append(input);
    input.focus();
    link.hide();
  }
  
  setValue(link, input, newValue) {
    console.log('Setting value to ' + newValue);
    this.changeCallback(link, newValue);
    link.attr('data-value', newValue);
    link.text(newValue || this.emptyText);
    link.show();
    input.datepicker('hide');
    input.remove();
  }
  
  makeInput(currValue, link) {
    let input = $('<input />').addClass('dateInput').val(currValue);
    input.datepicker({
        dateFormat: 'yy/mm/dd',
        'onSelect': dateText => {
          this.setValue(link, input, dateText);
        },
        onClose: () => {
          link.show();
          input.remove();
        },
        closeText: 'Clear',
        beforeShow: input => {
            setTimeout(() => {
              let widget = $(input).datepicker('widget');
              widget.find(".ui-datepicker-close").unbind("click").bind("click", () => $.datepicker._clearDate(input));
              console.log(widget.find('.ui-datepicker-current'));
              widget.find('.ui-datepicker-current').hide();
            })},
        showButtonPanel: true
    });
    return input;
  }
}
