
class AddItemDialog {
  constructor(sheetId, sheetName) {
    this.itemForm = $('.itemFormTemplate').first().clone().removeClass('itemFormTemplate');
    this.sheetName = sheetName;
    this.sheetId = sheetId;
    this.getPriorityElement().append($('<option />').attr('value', '').text('No Priority'));
    GlobalController.PRIORITIES.forEach(priority => this.getPriorityElement().append($('<option />').attr('value', priority).text(priority)));
  }
  
  getTitleElement() {
    return this.itemForm.find('.title');
  }
  
  getTitle() {
    return this.getTitleElement().val();
  }
  
  getUrlElement() {
    return this.itemForm.find('.url');
  }
  
  getUrl() {
    return this.getUrlElement().val();
  }
  
  getPriorityElement() {
    return this.itemForm.find('.priority');
  }
  
  getPriority() {
    return this.getPriorityElement().val();
  }
  
  getSubmitElement() {
    return this.itemForm.find('.addItem');
  }
  
  getFieldElements() {
    return this.itemForm.find('.field');
  }
  
  getErrorElement() {
    return this.itemForm.find('.error');
  }
  
  isDirty() {
    return this.getTitle() || this.getUrl() || this.getPriority();
  }
  
  validate(dirtyOnly) {
    let errors = [];
    if (!dirtyOnly || this.isDirty()) {
      if (!this.getTitle()) {
        errors.push('Title is a required field');
      }
    }
    if (errors.length > 0) {
      this.getErrorElement().text(errors.join(', ')).show();
      return false;
    }
    this.getErrorElement().hide();
    return true;
  }
  
  save() {
    if (!this.validate(false)) {
      console.log('not saving');
      return false;
    }
    var title = this.getTitle();
    new RpcConfig(runner => runner.AddItem_addItem(this.sheetId, title, this.getUrl(), this.getPriority())).
        output('Adding "' + title + '" to ' + this.sheetName + '...').
        retryOnTimeout().
        callRpc();
    return true;
  }
  
  show() {
    this.getFieldElements().change(() => this.validate(true));
    this.getUrlElement().change(() => {
      let title = this.getTitle();
      let url = this.getUrl();
      if (!title && url) {
        new RpcConfig(runner => runner.AddItem_getPageTitle(url)).
            retryOnTimeout().
            clearMessageOnSuccess().
            withSuccessFn(successMsg => {
              if (!this.getTitle()) {
                this.getTitleElement().val(successMsg);
                this.validate(true);
              }
            }).
            callRpc();
      }
    });
    let _this = this;
    this.itemForm.dialog({
      title: 'Add item to ' + this.sheetName,
      minWidth: 500,
      buttons: [
        {text: 'Add Item',
         click: () => {
           if (this.save()) {
             this.itemForm.dialog("close");
           }
         }
        },
        {text: "Cancel",
         click: () => {
           this.itemForm.dialog("close");
         }
        }
      ]
    });
  }
}