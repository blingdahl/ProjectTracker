class OverviewController {

  constructor() {
    this.jq = null;
    this.rowTemplateJq = null;
    this.elementMakers = {};
    this.elementMakers['PRIORITY'] = new OptionsLinkMaker(GlobalController.PRIORITIES, OverviewController.NO_PRIORITY_TEXT, 'priorityLink', rowData => rowData['PRIORITY'], rowData => rowData['PRIORITY'], this.handlePriorityChange.bind(this));
    this.elementMakers['STATUS'] = new OptionsLinkMaker(GlobalController.STATUSES, OverviewController.NO_STATUS_TEXT, 'statusLink', rowData => rowData['STATUS'], rowData => rowData['STATUS'], this.handleStatusChange.bind(this));
    this.elementMakers['ITEM'] = new EditableTextMaker('itemLink', rowData => rowData['ITEM'], rowData => rowData['ITEM'], this.handleItemChange.bind(this));
    this.elementMakers['SHEET'] = new OptionsLinkMaker(OverviewController.getSheetOptions(), 'Unexpected', 'changeSheetLink', rowData => rowData['SHEET'], rowData => rowData['SHEET_ID'], this.handleSheetChange.bind(this));
    this.elementMakers['VIEW_SHEET'] = new LinkMaker('viewSheetLink', () => 'View', rowData => rowData['SHEET_URL']);
    this.elementMakers['EMAIL'] = new LinkMaker('emailLink', () => 'Email', rowData => rowData['EMAIL_URL']);
    this.elementMakers['LINK'] = new LinkMaker('theLink', rowData => rowData['LINK'], rowData => rowData['LINK_URL'], OverviewController.makeAddLink);
    this.elementMakers['EMAIL_LAST_DATE'] = new TextMaker('emailLastDate', rowData => rowData['EMAIL_LAST_DATE_FORMATTED']);
    this.elementMakers['FROM'] = new TextMaker('fromDate', rowData => rowData['FROM']);
  }

  // SECTION:
  // Elements
  
  static getShowOverviewElement() {
    return $('.showOverview');
  }
  
  static getUpdateOverviewElement() {
    return $('.updateOverview');
  }
  
  static getHideOverviewElement() {
    return $('.hideOverview');
  }
  
  static getSortOverviewElement() {
    return $('.sortOverview');
  }
  
  static getPlaceholderElement() {
    return $('.overviewPlaceholder');
  }
  
  static getTemplateElement() {
    return $('.overviewTemplate');
  }
  
  getPriorityFilterElement() {
    return this.jq.find('.priorityFilter');
  }
  
  getStatusFilterElement() {
    return this.jq.find('.statusFilter');
  }
  
  getSheetFilterElement() {
    return this.jq.find('.sheetFilter');
  }
  
  getFilterElements() {
    return this.jq.find('.filter');
  }
  
  getShowColumnElements() {
    return this.jq.find('.showColumn');
  }
  
  getLoadTimeElement() {
    return this.jq.find('.loadTime');
  }
  
  getDisplayCountWrapperElement() {
    return this.jq.find('.displayCountWrapper');
  }
  
  getDisplayCountElement() {
    return this.jq.find('.displayCount');
  }
  
  getLoadingElement() {
    return this.jq.find('.overviewLoading');
  }
  
  getTableElement() {
    return this.jq.find('table');
  }
  
  getTbodyElement() {
    return this.jq.find('tbody').first();
  }
  
  getDataRowElements() {
    return this.getTbodyElement().find('tr[data-sheet-id]');
  }
  
  getColumnCells(columnKey) {
    return this.getTableElement().find('[data-key="' + columnKey + '"]');
  }

  // SECTION:
  // Click handlers
  
  handleStatusChange(link, newStatus) {
    let tr = $(link).closest('tr[data-sheet-id]');
    let sheetId = tr.attr('data-sheet-id');
    let uuid = tr.attr('data-uuid');
    tr.attr('data-status', newStatus);
    tr.attr('data-status-index', String(GlobalController.statusIndex(newStatus)).padStart(2, '0'));
    SheetController.forSheet(sheetId).setValue(uuid, 'Status', 'STATUS', newStatus);
  }
  
  handlePriorityChange(link, newPriority) {
    let tr = $(link).closest('tr[data-sheet-id]');
    let sheetId = tr.attr('data-sheet-id');
    let uuid = tr.attr('data-uuid');
    tr.attr('data-priority', newPriority);
    SheetController.forSheet(sheetId).setValue(uuid, 'Priority', 'PRIORITY', newPriority);
  }
  
  handleItemChange(link, newValue) {
    let tr = $(link).closest('tr[data-sheet-id]');
    let sheetId = tr.attr('data-sheet-id');
    let uuid = tr.attr('data-uuid');
    tr.attr('data-item', newValue);
    SheetController.forSheet(sheetId).setValue(uuid, 'Item', 'ITEM', newValue);
  }
  
  handleSheetChange(link, newSheetId) {
    let tr = $(link).closest('tr[data-sheet-id]');
    let sheetId = tr.attr('data-sheet-id');
    if (sheetId == newSheetId) {
      return;
    }
    let uuid = tr.attr('data-uuid');
    tr.attr('data-sheet-id', newSheetId);
    SheetController.forSheet(sheetId).changeSheet(uuid, newSheetId);
  }
  
  static makeAddLink(rowData) {
    return $('<a />').text('...').addClass('addLink').click(() => {
      let url = window.prompt('URL');
      if (url) {
        let sheetId = rowData['SHEET_ID'];
        let uuid = rowData['UUID'];
        new RpcConfig('ChangeRowValue_setLink', runner => runner.ChangeRowValue_setLink(sheetId, uuid, 'Link', 'LINK', url)).
            output('Add URL ' + url + '...').
            callRpc().
            then(() => {
              OverviewController.updateOverviewForSheet(sheetId);
            });
      }
    });
  }
  
  static getSheetOptions() {
    let ret = [];
    SheetController.getSheetInfos().forEach(sheetInfo => ret.push({text: sheetInfo.sheetName, value: sheetInfo.sheetId}));
    return ret;
  }
  
  static compareAttribute(a, b, attrName) {
    return a.attr('data-priority').compare(b.attr(attrName))
  }
  
  static compareAttributeFn(attrName) {
    return function(a, b) {
      return compare($(a).attr(attrName), $(b).attr(attrName));
    };
  }
  
  sortRows() {
    this.getDataRowElements().sort(
      compare.fn.chain(OverviewController.compareAttributeFn('data-priority'),
                       OverviewController.compareAttributeFn('data-status-index'),
                       OverviewController.compareAttributeFn('data-sheet-id'),
                       OverviewController.compareAttributeFn('data-uuid'))
    ).appendTo(this.getTbodyElement());
  }
  
  fillText(cellJq, rowData) {
    let key = cellJq.attr('data-key');
    let elementMaker = this.elementMakers[key];
    if (!elementMaker) {
      console.log('No element maker for ' + key);
      return;
    }
    let element = elementMaker.makeElement(rowData);
    if (element) {
      cellJq.append(element);
    }
  }
  
  addRow(rowData) {
    this.getTbodyElement().find('[data-uuid="' + rowData['UUID'] + '"]').remove();
    
    let rowJq = this.rowTemplateJq.clone().removeClass('overviewRowTemplate');
    
    rowJq.find('td[data-key]').each((index, elt) => this.fillText($(elt), rowData));
    
    rowJq.attr('data-sheet-id', rowData['SHEET_ID']);
    rowJq.attr('data-priority', rowData['PRIORITY'] || OverviewController.NO_PRIORITY_KEY);
    rowJq.attr('data-status', rowData['STATUS'] || OverviewController.NO_STATUS_KEY);
    rowJq.attr('data-status-index', String(GlobalController.statusIndex(rowData['STATUS'])).padStart(2, '0'));
    rowJq.attr('data-uuid', rowData['UUID']);
    
    this.getTbodyElement().append(rowJq);
  }
  
  handleData(msg) {
    let rows = JSON.parse(msg);
    this.setTableShown(true);
    rows.forEach(rowData => this.addRow(rowData));
    this.sortRows();
    this.applyFilters();
    this.getLoadingElement().hide();
  }
  
  populateFilter(filterElement, values, emptyKey, emptyName) {
    values.forEach(value => filterElement.append($('<option />').attr('value', value || emptyKey).text(value || emptyName)));
  }
  
  populateSheetFilter(filterElement, sheetInfos) {
    sheetInfos.sort((a, b) => a.sheetName > b.sheetName ? 1 : a.sheetName != b.sheetName ? -1 : 0);
    sheetInfos.forEach(sheetInfo => filterElement.append($('<option />').attr('value', sheetInfo.sheetId).text(sheetInfo.sheetName)));
  }
  
  applyFilterToRow(priority, status, sheetId, dataRowElt) {
    var show = true;
    if (priority && priority != dataRowElt.attr('data-priority')) {
      show = false;
    }
    if (status && status != dataRowElt.attr('data-status')) {
      show = false;
    }
    if (sheetId && sheetId != dataRowElt.attr('data-sheet-id')) {
      show = false;
    }
    if (show) {
      dataRowElt.show();
    } else {
      dataRowElt.hide();
    }
  }
  
  setColumnShown(showColumnJq) {
    let columnKey = showColumnJq.attr('data-key');
    let shown = showColumnJq.is(':checked');
    if (shown) {
      this.getColumnCells(columnKey).show();
    } else {
      this.getColumnCells(columnKey).hide();
    }
  }
  
  applyFilters() {
    this.getDataRowElements().each((idx, elt) => this.applyFilterToRow(
        this.getPriorityFilterElement().val(), this.getStatusFilterElement().val(), this.getSheetFilterElement().val(), $(elt)));
    this.getShowColumnElements().each((idx, elt) => this.setColumnShown($(elt)));
    this.getDisplayCountElement().text(this.getDataRowElements().filter(':visible').length);
    this.saveShowColumns();
  }
  
  showColumnStorageKey(dataKey) {
    return 'show_' + dataKey;
  }
  
  saveShowColumns() {
    this.getShowColumnElements().each((idx, elt) => {
      let jq = $(elt);
      var dataKey = jq.attr('data-key');
      sessionStorage.setItem(this.showColumnStorageKey(dataKey), String(jq.is(':checked')));
    });
  }
  
  initShowColumns() {
    this.getShowColumnElements().each((idx, elt) => {
      let jq = $(elt);
      var dataKey = jq.attr('data-key');
      let checked = sessionStorage.getItem(this.showColumnStorageKey(dataKey)) === 'true';
      if (checked) {
        jq.attr('checked', true);
      }
    });
    this.getShowColumnElements().change(() => this.applyFilters());
  }
  
  initFilters() {
    this.populateFilter(this.getPriorityFilterElement(), GlobalController.PRIORITIES, OverviewController.NO_PRIORITY_KEY, OverviewController.NO_PRIORITY_TEXT);
    this.populateFilter(this.getStatusFilterElement(), GlobalController.STATUSES, OverviewController.NO_STATUS_KEY, OverviewController.NO_STATUS_TEXT);
    this.populateSheetFilter(this.getSheetFilterElement(), SheetController.getSheetInfos());
    this.getFilterElements().change(() => this.applyFilters());
    this.initShowColumns();
  }
  
  initListeners() {
    for (let field in this.elementMakers) {
      this.elementMakers[field].attachClickHandler(this.jq);
    }
  }
  
  setTableShown(show) {
    if (show) {
      this.getTableElement().show();
      this.getDisplayCountWrapperElement().show();
    } else {
      this.getTableElement().hide();
      this.getDisplayCountWrapperElement().hide();
    }
  }
  
  init() {
    let templateJq = OverviewController.getTemplateElement();
    this.rowTemplateJq = templateJq.find('.overviewRowTemplate');
    this.jq = templateJq.clone().removeClass('overviewTemplate');
    this.jq.find('.overviewRowTemplate').remove();
    this.setTableShown(false);
    this.getLoadTimeElement().text(new Date());
    this.initFilters();
    this.load();
    this.initListeners();
    return this;
  }
  
  static updateButtons(showingOverview) {
    if (showingOverview) {
      OverviewController.getShowOverviewElement().hide();
      OverviewController.getUpdateOverviewElement().show();
      OverviewController.getHideOverviewElement().show();
      OverviewController.getSortOverviewElement().show();
    } else {
      OverviewController.getShowOverviewElement().show();
      OverviewController.getUpdateOverviewElement().hide();
      OverviewController.getHideOverviewElement().hide();
      OverviewController.getSortOverviewElement().hide();
    }
  }
  
  updateOverviewForSheet(sheetId) {
    this.getDataRowElements().filter('[data-sheet-id="' + sheetId + '"]').remove();
    $('.overviewPlaceholder').find('.overviewLoading').show();
    new RpcConfig('Overview_getRowsForSheetId', runner => runner.Overview_getRowsForSheetId(sheetId)).
        output('Loading overview for ' + SheetController.forSheet(sheetId).getSheetName() + '...').
        clearMessageOnSuccess().
        callRpc().
        then(msg => this.handleData(msg));
  }
  
  load() {
    $('.overviewPlaceholder').find('.overviewLoading').show();
    new RpcConfig('Overview_getRows', runner => runner.Overview_getRows()).
        output('Loading overview...').
        clearMessageOnSuccess().
        callRpc().
        then(msg => this.handleData(msg));
  }
  
  static updateOverview() {
    OverviewController.hideOverview(false);
    OverviewController.showOverview();
  }
  
  static updateOverviewForSheet(sheetId) {
    if (OverviewController.current) {
      OverviewController.current.updateOverviewForSheet(sheetId);
    } else {
      OverviewController.updateOverview();
    }
  }
  
  show() {
    this.init();
    OverviewController.getPlaceholderElement().append(this.jq.show());
    return this;
  }
  
  static showOverview() {
    OverviewController.hideOverview(false);
    google.script.history.push(null, null, 'overview');
    OverviewController.updateButtons(true);
    OverviewController.current = new OverviewController().show();
  }
  
  hide(opt_changeHistory) {
    if (opt_changeHistory === undefined || opt_changeHistory === true) {
      google.script.history.push(null, null, '');
    }
    this.jq.remove();
    OverviewController.updateButtons(false);
  }
  
  static hideOverview(opt_changeHistory) {
    if (OverviewController.current) {
      OverviewController.current.hide(opt_changeHistory);
      OverviewController.current = null;
    }
  }
  
  static sortOverview() {
    if (OverviewController.current) {
      OverviewController.current.sortRows();
    }
  }
  
  static handleShowOverviewClick() {
    OverviewController.showOverview();
  }
  
  static handleUpdateOverviewClick() {
    OverviewController.updateOverview();
  }
  
  static handleHideOverviewClick() {
    OverviewController.hideOverview();
  }
  
  static handleSortOverviewClick() {
    OverviewController.current.sortRows();
  }

  static addListeners() {
    OverviewController.getShowOverviewElement().click(OverviewController.handleShowOverviewClick);
    OverviewController.getUpdateOverviewElement().click(OverviewController.handleUpdateOverviewClick);
    OverviewController.getHideOverviewElement().click(OverviewController.handleHideOverviewClick);
    OverviewController.getSortOverviewElement().click(OverviewController.handleSortOverviewClick);
    $(document).keydown((event) => {
      var keycode = (event.keyCode ? event.keyCode : event.which);
      if (keycode === 85 && event.metaKey) {
        OverviewController.updateOverview();
        event.stopPropagation();
      }
    });
  }
  
  static init() {
    OverviewController.addListeners();
    google.script.url.getLocation(function(location) {
      if (location.hash === 'overview') {
        OverviewController.showOverview();
      }
    });
  }
}

OverviewController.current = null;

OverviewController.NO_PRIORITY_KEY = 'PUnknown';
OverviewController.NO_PRIORITY_TEXT = 'No Priority';
OverviewController.NO_STATUS_KEY = 'NoStatus';
OverviewController.NO_STATUS_TEXT = 'No Status';
