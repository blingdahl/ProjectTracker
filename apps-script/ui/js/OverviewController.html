class OverviewController {

  // SECTION:
  // Elements
  
  static getShowOverviewElement() {
    return $('.showOverview');
  }
  
  static getUpdateOverviewElement() {
    return $('.updateOverview');
  }
  
  static getHideOverviewElement() {
    return $('.hideOverview');
  }
  
  static getPlaceholderElement() {
    return $('.overviewPlaceholder');
  }
  
  static getTemplateElement() {
    return $('.overviewTemplate');
  }

  // SECTION:
  // Click handlers
  
  static makeLink(rowData, key) {
    return $('<a />').attr('href', rowData[key + '_URL']).attr('target', '_blank').text(rowData[key]);
  }
  
  static makePriorityElement(rowData, key) {
    let priorityElement = $('<a />');
    priorityElement.text(rowData['PRIORITY']);
    priorityElement.click(() => {
      priorityElement.hide();
      let cell = priorityElement.parent();
      let priorityDropdown = $('<select />');
      for (var i = 0; i != OverviewController.PRIORITIES.length; i++) {
        let priority = OverviewController.PRIORITIES[i];
        priorityDropdown.append($('<option />').attr('value', priority).attr('selected', priorityElement.text() === priority).text(priority));
      }
      priorityDropdown.change(() => {
        var newPriority = priorityDropdown.val();
        SheetController.forSheet(rowData['SHEET_ID']).setPriority(rowData['UUID'], newPriority);
        priorityDropdown.remove();
        priorityElement.text(newPriority).show();
      });
      cell.append(priorityDropdown);
    });
    return priorityElement;
  }
  
  static makeStatusElement(rowData, key) {
    let statusElement = $('<a />');
    statusElement.text(rowData['STATUS'] || 'No status');
    statusElement.click(() => {
      statusElement.hide();
      let cell = statusElement.parent();
      let statusDropdown = $('<select />');
      statusDropdown.append($('<option />').attr('value', '').text('No status'));
      for (var i = 0; i != OverviewController.STATUSES.length; i++) {
        let status = OverviewController.STATUSES[i];
        statusDropdown.append($('<option />').attr('value', status).attr('selected', statusElement.text() === status).text(status));
      }
      statusDropdown.change(() => {
        var newStatus = statusDropdown.val();
        SheetController.forSheet(rowData['SHEET_ID']).setStatus(rowData['UUID'], newStatus);
        statusDropdown.remove();
        statusElement.text(newStatus).show();
      });
      cell.append(statusDropdown);
    });
    return statusElement;
  }
  
  static statusIndex(row) {
    var idx = OverviewController.STATUSES.indexOf(row['STATUS']);
    if (idx == -1) {
      idx = 20;
    }
    return idx;
  }
  
  static handleOverviewData(priority, msg) {
    let data = JSON.parse(msg);
    data.sort(function(a, b) {
      return OverviewController.statusIndex(a) - OverviewController.statusIndex(b);
    });
    let overviewRowTemplate = $('.overviewTemplate').find('.overviewRowTemplate');
    let overviewTable = $('.overviewPlaceholder').find('table').show();
    data.forEach(rowData => {
      let overviewRow = overviewRowTemplate.clone().removeClass('overviewRowTemplate');
      overviewRow.find('.sheet').append(OverviewController.makeLink(rowData, 'SHEET'));
      overviewRow.find('.item').text(rowData['ITEM']);
      overviewRow.find('.priority').append(OverviewController.makePriorityElement(rowData));
      overviewRow.find('.status').append(OverviewController.makeStatusElement(rowData));
      overviewRow.find('.email').append(OverviewController.makeLink(rowData, 'EMAIL'));
      overviewRow.find('.link').append(OverviewController.makeLink(rowData, 'LINK'));
      if (rowData['STATUS'] === 'Completed' || rowData['STATUS'] === 'Obsolete') {
        overviewRow.addClass('completed');
      } else {
        overviewRow.find('.markCompleted').show().click(() => SheetController.forSheet(rowData['SHEET_ID']).setAction(rowData['UUID'], 'Completed').then(() => {
            overviewRow.addClass('completed');
        }));
      }
      overviewTable.append(overviewRow);
    });
    let nextPriority = OverviewController.getNextPriority(priority);
    let loadPriorityLink = $('.overviewPlaceholder').find('.loadPriority');
    $('.overviewPlaceholder').find('.priorityLoading').hide();
    if (nextPriority !== null) {
      loadPriorityLink.text('Load ' + nextPriority).click(() => OverviewController.loadPriority(nextPriority)).show();
    }
  }
  
  static loadPriority(priority) {
    $('.overviewPlaceholder').find('.loadPriority').hide();
    $('.overviewPlaceholder').find('.priorityLoading').show();
    new RpcConfig(runner => runner.Overview_getOverviewRows([priority])).
        output('Loading ' + priority + '...').
        clearMessageOnSuccess().
        withSuccessFn(msg => OverviewController.handleOverviewData(priority, msg)).
        callRpc();
  }
  
  static isDisplayed() {
    return $('.overviewPlaceholder').find('table').length > 0;
  }
  
  static updateOverview() {
    if (OverviewController.isDisplayed()) {
      OverviewController.showOverview();
    }
  }
  
  static updateButtons(showingOverview) {
    if (showingOverview) {
      OverviewController.getShowOverviewElement().hide();
      OverviewController.getUpdateOverviewElement().show();
      OverviewController.getHideOverviewElement().show();
    } else {
      OverviewController.getShowOverviewElement().show();
      OverviewController.getUpdateOverviewElement().hide();
      OverviewController.getHideOverviewElement().hide();
    }
  }
  
  static showOverview() {
    OverviewController.hideOverview(false);
    google.script.history.push(null, null, 'overview');
    let overviewTemplate = OverviewController.getTemplateElement();
    let overview = overviewTemplate.clone().removeClass('overviewTemplate');
    overview.find('.overviewRowTemplate').remove();
    OverviewController.getPlaceholderElement().append(overview.show());
    OverviewController.getPlaceholderElement().find('table').hide();
    OverviewController.getPlaceholderElement().find('.loadTime').text(new Date());
    OverviewController.updateButtons(true);
    OverviewController.loadPriority('P0');
  }
  
  static hideOverview(opt_changeHistory) {
    if (opt_changeHistory === undefined || opt_changeHistory === true) {
      google.script.history.push(null, null, '');
    }
    $('.overviewPlaceholder').empty();
    OverviewController.updateButtons(false);
  }
  
  static getNextPriority(priority) {
    let useNext = false;
    let ret = null;
    OverviewController.PRIORITIES.forEach(p => {
      if (ret) {
        return;
      }
      if (useNext) {
        ret = p;
      } else {
        if (p === priority) {
          useNext = true;
        }
      }
    });
    return ret;
  }

  static addListeners() {
    OverviewController.getShowOverviewElement().click(OverviewController.showOverview);
    OverviewController.getUpdateOverviewElement().click(OverviewController.updateOverview);
    OverviewController.getHideOverviewElement().click(OverviewController.hideOverview);
  }
  
  static init() {
    OverviewController.addListeners();
    google.script.url.getLocation(function(location) {
      if (location.hash === 'overview') {
        OverviewController.showOverview();
      }
    });
  }
}

// TODO(lindahl) Get from server
OverviewController.PRIORITIES = ['P0', 'P1', 'P2', 'P3', 'P4', ''];

OverviewController.STATUSES = ['Completed', 'Obsolete', 'In Progress', 'On Deck', 'Waiting', 'Following', 'Backburner'];
