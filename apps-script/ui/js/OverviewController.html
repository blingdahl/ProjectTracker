class OverviewController {

  // SECTION:
  // Elements
  
  static getShowOverviewElement() {
    return $('.showOverview');
  }
  
  static getUpdateOverviewElement() {
    return $('.updateOverview');
  }
  
  static getHideOverviewElement() {
    return $('.hideOverview');
  }
  
  static getPlaceholderElement() {
    return $('.overviewPlaceholder');
  }
  
  static getTemplateElement() {
    return $('.overviewTemplate');
  }
  
  static getPriorityFilterElement() {
    return OverviewController.getPlaceholderElement().find('.priorityFilter');
  }
  
  static getStatusFilterElement() {
    return OverviewController.getPlaceholderElement().find('.statusFilter');
  }
  
  static getSheetFilterElement() {
    return OverviewController.getPlaceholderElement().find('.sheetFilter');
  }
  
  static getFilterElements() {
    return OverviewController.getPlaceholderElement().find('.filter');
  }
  
  static getDataRowElements() {
    return OverviewController.getPlaceholderElement().find('tr[data-sheet-id]');
  }

  // SECTION:
  // Click handlers
  
  static makeLink(rowData, key) {
    return $('<a />').attr('href', rowData[key + '_URL']).attr('target', '_blank').text(rowData[key]);
  }
  
  static statusIndex(rowData) {
    var idx = OverviewController.STATUSES.indexOf(rowData['STATUS']);
    if (idx == -1) {
      idx = 20;
    }
    return idx;
  }
  
  static priorityIndex(rowData) {
    var idx = OverviewController.PRIORITIES.indexOf(rowData['PRIORITY']);
    if (idx == -1) {
      idx = 20;
    }
    return idx;
  }
  
  static addRow(overviewTable, overviewRowTemplate, rowData) {
    let overviewRow = overviewRowTemplate.clone().removeClass('overviewRowTemplate');
    overviewRow.find('.sheet').append(OverviewController.makeLink(rowData, 'SHEET'));
    overviewRow.find('.item').text(rowData['ITEM']);
    overviewRow.find('.priority').append(OverviewController.PRIORITY_DROPDOWN_MAKER.makeElement(rowData, 'PRIORITY'));
    overviewRow.find('.status').append(OverviewController.STATUS_DROPDOWN_MAKER.makeElement(rowData, 'STATUS'));
    overviewRow.find('.email').append(OverviewController.makeLink(rowData, 'EMAIL'));
    overviewRow.find('.link').append(OverviewController.makeLink(rowData, 'LINK'));
    if (rowData['STATUS'] === 'Completed' || rowData['STATUS'] === 'Obsolete') {
      overviewRow.addClass('completed');
    }
    overviewRow.attr('data-sheet-id', rowData['SHEET_ID']);
    overviewRow.attr('data-priority', rowData['PRIORITY']);
    overviewRow.attr('data-status', rowData['STATUS']);
    overviewTable.append(overviewRow);
  }
  
  static handleDataByPriority(overviewTable, msg) {
    let rowsByPriority = JSON.parse(msg);
    let overviewRowTemplate = $('.overviewTemplate').find('.overviewRowTemplate');
    overviewTable.show();
    OverviewController.PRIORITIES.forEach(priority => {
      var rowsForPriority = rowsByPriority[priority];
      if (!rowsForPriority) {
        return;
      }
      rowsForPriority.sort((a, b) => OverviewController.statusIndex(a) - OverviewController.statusIndex(b));
      rowsForPriority.forEach(rowData => {
        OverviewController.addRow(overviewTable, overviewRowTemplate, rowData);
      });
    });
    OverviewController.applyFilters();
    $('.overviewPlaceholder').find('.overviewLoading').hide();
  }
  
  static load(overviewTable) {
    $('.overviewPlaceholder').find('.overviewLoading').show();
    new RpcConfig(runner => runner.Overview_getRowsByPriority()).
        output('Loading overview...').
        clearMessageOnSuccess().
        withSuccessFn(msg => OverviewController.handleDataByPriority(overviewTable, msg)).
        callRpc();
  }
  
  static isDisplayed() {
    return $('.overviewPlaceholder').find('table').length > 0;
  }
  
  static updateOverview() {
    if (OverviewController.isDisplayed()) {
      OverviewController.showOverview();
    }
  }
  
  static updateButtons(showingOverview) {
    if (showingOverview) {
      OverviewController.getShowOverviewElement().hide();
      OverviewController.getUpdateOverviewElement().show();
      OverviewController.getHideOverviewElement().show();
    } else {
      OverviewController.getShowOverviewElement().show();
      OverviewController.getUpdateOverviewElement().hide();
      OverviewController.getHideOverviewElement().hide();
    }
  }
  
  static populateFilter(filterElement, values) {
    values.forEach(value => filterElement.append($('<option />').attr('value', value).text(value)));
  }
  
  static applyFilterToRow(priority, status, sheetId, dataRowElt) {
    var show = true;
    if (priority && priority != dataRowElt.attr('data-priority')) {
      show = false;
      console.log('Not showing');
    }
    if (status && status != dataRowElt.attr('data-status')) {
      show = false;
    }
    if (sheetId && sheetId != dataRowElt.attr('data-sheet-id')) {
      show = false;
    }
    if (show) {
      dataRowElt.show();
    } else {
      dataRowElt.hide();
    }
  }
  
  static applyFilters() {
    var priority = OverviewController.getPriorityFilterElement().val();
    var status = OverviewController.getStatusFilterElement().val();
    var sheetId = OverviewController.getSheetFilterElement().val();
    console.log(priority);
    console.log(status);
    console.log(sheetId);
    this.getDataRowElements().each((idx, elt) => OverviewController.applyFilterToRow(priority, status, sheetId, $(elt)));
  }
  
  static showOverview() {
    OverviewController.hideOverview(false);
    google.script.history.push(null, null, 'overview');
    let overviewTemplate = OverviewController.getTemplateElement();
    let overview = overviewTemplate.clone().removeClass('overviewTemplate');
    overview.find('.overviewRowTemplate').remove();
    OverviewController.getPlaceholderElement().append(overview.show());
    var overviewTable = OverviewController.getPlaceholderElement().find('table').hide();
    OverviewController.getPlaceholderElement().find('.loadTime').text(new Date());
    OverviewController.updateButtons(true);
    OverviewController.populateFilter(OverviewController.getPriorityFilterElement(), OverviewController.PRIORITIES);
    OverviewController.populateFilter(OverviewController.getStatusFilterElement(), OverviewController.STATUSES);
    OverviewController.getFilterElements().change(() => this.applyFilters());
    OverviewController.load(overviewTable);
  }
  
  static hideOverview(opt_changeHistory) {
    if (opt_changeHistory === undefined || opt_changeHistory === true) {
      google.script.history.push(null, null, '');
    }
    $('.overviewPlaceholder').empty();
    OverviewController.updateButtons(false);
  }

  static addListeners() {
    OverviewController.getShowOverviewElement().click(OverviewController.showOverview);
    OverviewController.getUpdateOverviewElement().click(OverviewController.updateOverview);
    OverviewController.getHideOverviewElement().click(OverviewController.hideOverview);
  }
  
  static init() {
    OverviewController.addListeners();
    google.script.url.getLocation(function(location) {
      if (location.hash === 'overview') {
        OverviewController.showOverview();
      }
    });
  }
}

// TODO(lindahl) Get from server
OverviewController.PRIORITIES = ['P0', 'P1', 'P2', 'P3', 'P4', ''];

OverviewController.STATUSES = ['Completed', 'Obsolete', 'In Progress', 'On Deck', 'Waiting', 'Following', 'Backburner'];

OverviewController.PRIORITY_DROPDOWN_MAKER = new DropdownPickerMaker(OverviewController.PRIORITIES,
    (rowData, newPriority) => SheetController.forSheet(rowData['SHEET_ID']).setPriority(rowData['UUID'], newPriority), 'No Priority')

OverviewController.STATUS_DROPDOWN_MAKER = new DropdownPickerMaker(OverviewController.STATUSES,
    (rowData, newStatus) => SheetController.forSheet(rowData['SHEET_ID']).setStatus(rowData['UUID'], newStatus), 'No Status')
