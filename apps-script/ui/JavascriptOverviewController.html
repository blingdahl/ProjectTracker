class OverviewController {

  // SECTION:
  // Elements
  
  static getShowOverviewElement() {
    return $('.showOverview');
  }

  // SECTION:
  // Click handlers
  
  static makeLink(rowData, key) {
    return $('<a />').attr('href', rowData[key + '_URL']).attr('target', '_NEW').text(rowData[key]);
  }
  
  static handleOverviewData(priority, msg) {
    let data = JSON.parse(msg);
    let overviewRowTemplate = $('.overviewTemplate').find('.overviewRowTemplate');
    let overviewTable = $('.overviewPlaceholder').find('table').show();
    data.forEach(rowData => {
      let overviewRow = overviewRowTemplate.clone().removeClass('overviewRowTemplate');
      overviewRow.find('.sheet').append(OverviewController.makeLink(rowData, 'SHEET'));
      overviewRow.find('.item').text(rowData['ITEM']);
      overviewRow.find('.priority').text(rowData['PRIORITY']);
      overviewRow.find('.email').append(OverviewController.makeLink(rowData, 'EMAIL'));
      overviewRow.find('.link').append(OverviewController.makeLink(rowData, 'LINK'));
      if (rowData['ACTION'] === 'Completed' || rowData['ACTION'] === 'Untrack') {
        overviewRow.addClass('completed');
        overviewRow.find('.action').text(rowData['ACTION']);
      } else {
        let link;
        let action;
        if (rowData['THREAD_ID']) {
          link = overviewRow.find('.untrack');
          action = 'Untrack';
        } else {
          link = overviewRow.find('.markCompleted');
          action = 'Completed';
        }
        link.show().click(() => SheetController.forSheet(rowData['SHEET_ID']).setAction(rowData['UUID'], action).then(() => {
            overviewRow.addClass('completed');
        }));
      }
      overviewTable.append(overviewRow);
    });
    let nextPriority = {'P0': 'P1', 'P1': 'P2', 'P2': 'P3', 'P3': 'P4'}[priority];
    let loadPriorityLink = $('.overviewPlaceholder').find('.loadPriority');
    $('.overviewPlaceholder').find('.priorityLoading').hide();
    if (nextPriority) {
      loadPriorityLink.text('Load ' + nextPriority).click(() => OverviewController.loadPriority(nextPriority)).show();
    }
  }
  
  static loadPriority(priority) {
    $('.overviewPlaceholder').find('.loadPriority').hide();
    $('.overviewPlaceholder').find('.priorityLoading').show();
    new RpcConfig(runner => runner.getOverviewRows(GlobalController.getSpreadsheetUrl(), [priority])).
        output('Loading ' + priority + '...').
        clearMessageOnSuccess().
        withSuccessFn(msg => OverviewController.handleOverviewData(priority, msg)).
        callRpc();
  }
  
  static showOverview() {
    google.script.history.push(null, null, 'overview');
    $('.controls').hide();
    let overviewTemplate = $('.overviewTemplate');
    let overview = overviewTemplate.clone().removeClass('overviewTemplate');
    overview.find('.overviewRowTemplate').remove();
    $('.overviewPlaceholder').append(overview.show());
    $('.overviewPlaceholder').find('table').hide();
    overview.find('.hideOverview').click(OverviewController.hideOverview);
    OverviewController.loadPriority('P0');
  }
  
  static hideOverview() {
    google.script.history.push(null, null, '');
    $('.controls').show();
    $('.overviewPlaceholder').empty();
  }

  static addListeners() {
    OverviewController.getShowOverviewElement().click(OverviewController.showOverview);
  }
  
  static init() {
    OverviewController.addListeners();
    google.script.url.getLocation(function(location) {
      if (location.hash === 'overview') {
        OverviewController.showOverview();
      }
    });
  }
}
