class RpcConfig {
  constructor(callFn) {
    this.callFn_ = callFn;
    this.successOut_ = this.output.bind(this);
    this.failureOut_ = this.append.bind(this);
    this.successFn_ = null;
    this.failureFn_ = null;
  }
  
  retryOnTimeout() {
    if (!RpcConfig.ALLOW_RETRIES) {
      return this;
    }
    return this.logAll().withFailureFn(function(errorMsg) {
          if (errorMsg === 'ScriptError: Exceeded maximum execution time') {
            console.log(errorMsg);
            this.callRpc();
            return;
            this.output(errorMsg);
          }
        }.bind(this));
  }
  
  logSuccess() {
    this.successOut_ = Log.log;
    return this;
  }
  
  logFailure() {
    this.failureOut_ = Log.log;
    return this;
  }
  
  logAll() {
    return this.logSuccess().logFailure();
  }
  
  ignoreSuccess() {
    this.successOut_ = () => null;
    return this;
  }
  
  ignoreFailure() {
    this.failureOut_ = () => null;
    return this;
  }
  
  clearMessageOnSuccess() {
    this.successOut_ = () => this.removeRpcDiv_();
    return this;
  }
  
  setMessageOnSuccess(msg) {
    this.successOut_ = () => this.output(msg);
    return this;
  }
  
  clearMessageOnFailure() {
    this.failureOut_ = () => this.removeRpcDiv_();
    return this;
  }
  
  setMessageOnFailure(msg) {
    this.failureOut_ = () => this.output(msg);
    return this;
  }

  ignoreAll() {
    return this.ignoreSuccess().ignoreFailure();
  }
  
  withSuccessFn(successFn) {
    this.successFn_ = successFn;
    return this;
  }
  
  withFailureFn(failureFn) {
    this.failureFn_ = failureFn;
    return this;
  }
  
  removeRpcDiv_() {
    if (this.rpcDiv_) {
      this.rpcDiv_.hide('blind', null, 1000);
    }
  }
  
  makeRemoveLog_() {
    let removeLog = $('<div />').addClass('removeLog').text('âœ•');
    removeLog.click(this.removeRpcDiv_.bind(this));
    return removeLog;
  }
  
  handleSuccess_(msg) {
    this.successOut_(msg);
    if (this.successFn_) {
      this.successFn_(msg);
    }
    if (this.rpcDiv_) {
      this.rpcDiv_.append(this.makeRemoveLog_());
    }
  }
  
  handleFailure_(msg) {
    this.failureOut_(msg);
    if (this.failureFn_) {
      this.failureFn_(msg);
    }
    if (this.rpcDiv_) {
      this.rpcDiv_.append(this.makeRemoveLog_());
    }
  }
  
  getRpcDiv_() {
    if (!this.rpcDiv_) {
      this.rpcDiv_ = $('<div />').addClass('rpcMessage');
      $('.rpcMessages').append(this.rpcDiv_);
    }
    return this.rpcDiv_;
  }
  
  output(msg) {
    this.getRpcDiv_().text(msg);
    return this;
  }
  
  append(msg) {
    var rpcDiv = this.getRpcDiv_();
    rpcDiv.text(rpcDiv.text() + msg);
    return this;
  }
  
  callRpc() {
    return new Promise(function(resolve, reject) {
          this.callFn_(
              google.script.run.
                  withSuccessHandler(msg => resolve(msg)).
                  withFailureHandler(err => reject(err)));
        }.bind(this)).then(this.handleSuccess_.bind(this), this.handleFailure_.bind(this));
  }
  
  static clearCompleted() {
    $('.removeLog').click();
  }
  
  static addGlobalListeners() {
    $('.clearCompleted').click(RpcConfig.clearCompleted);
  }
  
  static init() {
    RpcConfig.addGlobalListeners();
  }
}

RpcConfig.ALLOW_RETRIES = false;