<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <style>
      h1 {
        font-family: sans-serif;
        font-size: 13px;
      }
      
      div {
        font-family: sans-serif;
      }
      
      error {
        color: red;
      }
      
      .labelPicker {
        margin-bottom: 10px;
      }
      
      .labelName {
        text-decoration: underline;
        color: blue;
        cursor: pointer;
      }
      
      h1 {
        margin-top: 30px;
      }
    </style>
    <div class="global" style="display: none" 
        data-sheet-id="<?= sheetId ?>"
        data-sheet-name="<?= sheetName ?>" 
        data-is-tracked="<?= isTracked ?>"
        data-label-name="<?= label ?>"></div>   
    <div class="message"></div>
    <div class="error"></div>
    <div class="sheetController">
      <h1><span class="sheetName"></span> sheet</h1>
      <div class="untracked" style="display: none">
      <button class="trackButton">Track sheet</button>
      </div>
      <div class="tracked" style="display: none">
        <div class="labelPicker">
          <div class="labelDisplayMode" style="display: none">
            <span class="labelName"></span>
            <button class="removeLabelButton">Remove</button>
          </div>
          <div class="labelSelectMode" style="display: none">
            <select class="labelSelect">
            </select>
            <button class="selectLabelButton">Select</button>
            <button class="cancelLabelButton">Cancel</button>
          </div>
        </div>
        <button class="syncWithGmailButton">Sync with Gmail</button>
        <button class="organizeButton">Organize</button>
        </div>
      </div>
      <h1>All Sheets</h1>
      <button class="syncAllWithGmailButton">Sync All with Gmail</button>
      <button class="organizeAllButton">Organize All</button>
      <button class="updateOverviewButton">Update Overview</button>
      <button class="doAllTheThingsButton">Do all the things!</button>
  </body>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
  let MODE = {'SELECT': 1, 'DISPLAY': 2};
  
  class Global {
    static getElt() {
      return $('.global');
    }
  
    static getAttr(attrName) {
      return Global.getElt().attr(attrName);
    }
  
    static setAttr(attrName, value) {
      Global.getElt().attr(attrName, value);
    }
    
    static getSheetName() {
      return Global.getAttr('data-sheet-name');
    }
  
    static setSheetName(name) {
      return Global.setAttr('data-sheet-name', name);
    }
  
    static getSheetId() {
      return Global.getAttr('data-sheet-id');
    }
  
    static setSheetId(sheetId) {
      return Global.setAttr('data-sheet-id', sheetId);
    }

    static getIsTracked() {
      return Global.getAttr('data-is-tracked');
    }
    
    static setIsTracked(tracked) {
      Global.setAttr('data-is-tracked', String(tracked));
    }
    
    static getCurrLabel() {
      return Global.getAttr('data-label-name');
    }
    
    static setCurrLabel(label) {
      return Global.setAttr('data-label-name', label);
    }
    
    static clearCurrLabel() {
      Global.setCurrLabel(null);
    }

    static setMessage(msg) {
      Global.clearError();
      $('.message').text(msg);
    }

    static clearMessage() {
      if ($('.message').text() !== '') {
        Global.setMessage('');
      }
    }

    static setError(msg) {
      Global.clearMessage();
      $('.error').text(msg);
    }

    static clearError(msg) {
      if ($('.error').text() !== '') {
        Global.setError('');
      }
    }
  }
    
  // TODO(lindahl) Retry timeout: "ScriptError: Exceeded maximum execution time"
  // TODO(lindahl) Swallow 409: "NetworkError: Connection failure due to HTTP 409"
  
  class AlternatingVisibility {
    constructor(name) {
      this.name = name;
      this.jqMap = {};
    }
    
    map(key, jqs) {
      this.jqMap[String(key)] = jqs;
      return this;
    }
    
    setVisible(visibleKey) {
      console.log('For ' + this.name);
      console.log('setVisible(' + visibleKey + ')');
      visibleKey = String(visibleKey);
      if (!this.jqMap[visibleKey]) {
        throw new Error('Invalid key: ' + visibleKey);
      }
      let keys = Object.keys(this.jqMap);
      for (let i = 0; i < keys.length; i++) {
        let key = keys[i];
        let jq = this.jqMap[key];
        if (visibleKey === key) {
          jq.show();
        } else {
          jq.hide();
        }
      }
    }
  }
  
  class LabelPicker {
    static getSelectElement() {
      return $('.labelSelect');
    }

    static clearSelectOptions(initialOptionText) {
      LabelPicker.getSelectElement().find('option').remove();
      LabelPicker.getSelectElement().append($('<option />').text(initialOptionText));
    }
    
    static populateSelect(labels) {
      LabelPicker.clearSelectOptions('Select Label');
      let currLabel = Global.getCurrLabel();
      labels.sort();
      for (let i = 0; i < labels.length; i++) {
        let label = labels[i];
        let newOption = $('<option />').val(label).text(label);
        LabelPicker.getSelectElement().append(newOption)
        if (currLabel == label) {
          newOption.prop('selected', true);
        }
      }
    }

    static getLabelNameElt() {
      return $('.labelName');
    }
  
    static setMode(mode) {
      if (mode == MODE.SELECT) {
        LabelPicker.DISPLAY_MODE_VISIBILITY.setVisible(MODE.SELECT)
      } else if (mode == MODE.DISPLAY) {
        LabelPicker.DISPLAY_MODE_VISIBILITY.setVisible(MODE.DISPLAY)
        let labelName = Global.getCurrLabel();
        LabelPicker.getLabelNameElt().text(labelName || 'Choose label...');
        LabelPicker.LABEL_BUTTON_VISIBILITY.setVisible(!!labelName);
      } else {
        throw new Error('Unexpected mode: ' + mode);
      }
    }
    
    static updateCurrLabelFromSelect() {
      let ret = LabelPicker.getSelectElement().val();
      Global.setCurrLabel(ret);
      return ret;
    }
  }
  
  LabelPicker.DISPLAY_MODE_VISIBILITY = new AlternatingVisibility('DisplayMode').
      map(MODE.SELECT, $('.labelSelectMode')).
      map(MODE.DISPLAY, $('.labelDisplayMode'));
  
  LabelPicker.LABEL_BUTTON_VISIBILITY = new AlternatingVisibility('LabelButton').
      map(true, $('.removeLabelButton,.syncWithGmailButton')).
      map(false, $('.noButtonExisting'));
  
  class Gmail {
    static populateLabelSelect() {
      LabelPicker.clearSelectOptions('Populating...');
      google.script.run.withSuccessHandler(function(labels) {
        LabelPicker.populateSelect(JSON.parse(labels));
      }).getAllLabels();
    }
    
    static removeLabelClicked() {
      Global.clearCurrLabel();
      google.script.run.clearLabelForSheet(Global.getSheetId());
      LabelPicker.setMode(MODE.DISPLAY);
    }
  }
  
  class SheetController {
    static setTracked(tracked) {
      Global.setIsTracked(tracked);
      google.script.run.setTrackedForSheet(Global.getSheetId(), tracked);
    }
    
    static getSheetNameElt() {
      return $('.sheetName');
    }
    
    static hide() {
      $('.sheetController').hide();
    }
    
    static labelNameClicked() {
      Gmail.populateLabelSelect();
      LabelPicker.setMode(MODE.SELECT);
    }
    
    static show() {
      SheetController.getSheetNameElt().text(Global.getSheetName());
      SheetController.TRACKED_VISIBILITY.setVisible(Global.getIsTracked());
      LabelPicker.setMode(MODE.DISPLAY);
      $('.sheetController').show();
    }
    
    static trackClicked() {
      SheetController.setTracked(true);
      SheetController.show();
    }

    static init() {
      console.log('init()');
      SheetController.show();
    }

    static organizeClicked() {
      Global.setMessage('Organizing...');
      google.script.run.withSuccessHandler(Global.setMessage).withFailureHandler(Global.setError).organize(Global.getSheetId());
    }
    
    static cancelLabelClicked() {
      LabelPicker.setMode(MODE.DISPLAY);
    }
    
    static selectLabelClicked() {
      google.script.run.setLabelForSheet(Global.getSheetId(), LabelPicker.updateCurrLabelFromSelect());
      LabelPicker.setMode(MODE.DISPLAY);
    }

    static syncWithGmailClicked() {
      Global.setMessage('Syncing...');
      Global.clearError();
      google.script.run.withSuccessHandler(Global.setMessage).withFailureHandler(Global.setError).syncSheetWithGmail(Global.getSheetId());
    }

    static syncAllWithGmailClicked() {
      Global.setMessage('Syncing all...');
      Global.clearError();
      google.script.run.withSuccessHandler(Global.setMessage).withFailureHandler(Global.setError).syncAllSheetsWithGmail();
    }
    
    static addListeners() {
      $('.labelName').click(SheetController.labelNameClicked);
      $('.removeLabelButton').click(SheetController.removeLabelClicked);
      $('.cancelLabelButton').click(SheetController.cancelLabelClicked);
      $('.selectLabelButton').click(SheetController.selectLabelClicked);
      $('.syncWithGmailButton').click(SheetController.syncWithGmailClicked);
      $('.organizeButton').click(SheetController.organizeClicked);
    }
    
    static checkActiveSheetId() {
      function getActiveSheetIdSuccessHandler(activeSheetId) {
        if (activeSheetId != Global.getSheetId()) {
          SheetController.hide();
          function preferencesSuccessHandler(preferencesStr) {
            let preferences = JSON.parse(preferencesStr);
            Global.setSheetId(activeSheetId);
            Global.setSheetName(preferences.sheetName);
            Global.setIsTracked(preferences.isTracked);
            Global.setCurrLabel(preferences.label);
            SheetController.show();
          }
          google.script.run.withSuccessHandler(preferencesSuccessHandler).withFailureHandler(Global.setError).getPreferencesForSheet(activeSheetId);
        }
      }
      google.script.run.withSuccessHandler(getActiveSheetIdSuccessHandler).withFailureHandler(Global.setError).getActiveSheetId();
    }
    
    static init() {
      SheetController.addListeners();
      SheetController.show();
      window.setInterval(SheetController.checkActiveSheetId, 1000);
    }
  }
  
  SheetController.TRACKED_VISIBILITY = new AlternatingVisibility('Tracked').
      map(true, $('.tracked')).
      map(false, $('.untracked'));
  
  class GlobalController {
    static organizeAllClicked() {
      Global.setMessage('Organizing all...');
      Global.clearError();
      google.script.run.withSuccessHandler(Global.setMessage).withFailureHandler(Global.setError).organizeAll();
    }

    static updateOverviewClicked() {
      Global.setMessage('Updating overview...');
      Global.clearError();
      google.script.run.withSuccessHandler(Global.setMessage).withFailureHandler(Global.setError).updateOverview();
    }

    static doAllTheThingsClicked() {
      Global.setMessage('Doing all the things...');
      Global.clearError();
      google.script.run.withSuccessHandler(Global.setMessage).withFailureHandler(Global.setError).doAllTheThings();
    }

    static addListeners() {
      $('.syncAllWithGmailButton').click(GlobalController.syncAllWithGmailClicked);
      $('.organizeAllButton').click(GlobalController.organizeAllClicked);
      $('.updateOverviewButton').click(GlobalController.updateOverviewClicked);
      $('.doAllTheThingsButton').click(GlobalController.doAllTheThingsClicked);
    }
    
    static init() {
      GlobalController.addListeners();
    }
  }
  
  SheetController.init();
  GlobalController.init();
  
  </script>
</html>
