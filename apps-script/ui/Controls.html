<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <style>
      h1 {
        font-family: sans-serif;
        font-size: 13px;
      }
      
      div {
        font-family: sans-serif;
      }
      
      error {
        color: red;
      }
      
      .labelPicker {
        margin-bottom: 10px;
      }
      
      .labelName {
        text-decoration: underline;
        color: blue;
        cursor: pointer;
      }
      
      .toggleRefreshing {
        font-size: 8px;
        text-decoration: underline;
        cursor: pointer;
        margin-top: 10px;
      }
      
      .maxThreads {
        width: 30px;
      }
      
      h1 {
        margin-top: 30px;
      }
    </style>
    <div class="global" style="display: none" 
        data-sheet-id="<?= preferences.sheetId ?>"
        data-sheet-name="<?= preferences.sheetName ?>" 
        data-is-tracked="<?= preferences.isTracked ?>"
        data-label-name="<?= preferences.label ?>"
        data-max-threads="<?= preferences.maxThreads ?>"></div>   
    <div class="message"></div>
    <div class="error"></div>
    <div class="sheetController">
      <h1><span class="sheetName"></span> sheet</h1>
      <div class="untracked" style="display: none">
      <button class="trackButton">Track sheet</button>
      </div>
      <div class="tracked" style="display: none">
        <div class="labelPicker">
          <div class="labelDisplayMode" style="display: none">
            <span class="labelName"></span>
            <button class="removeLabelButton">Remove</button>
            <button class="renameLabelButton">Rename</button>
          </div>
          <div class="labelSelectMode" style="display: none">
            <select class="labelSelect">
            </select>
            <input type="text" class="maxThreads">
            <button class="saveButton">Save</button>
            <button class="cancelLabelButton">Cancel</button>
          </div>
        </div>
        <button class="syncWithGmailButton">Sync with Gmail</button>
        <button class="organizeButton">Organize</button>
        </div>
      </div>
      <h1>All Sheets</h1>
      <button class="syncAllWithGmailButton">Sync All with Gmail</button>
      <button class="organizeAllButton">Organize All</button>
      <button class="updateOverviewButton">Update Overview</button>
      <button class="doAllTheThingsButton">Do all the things!</button>
      <div class="toggleRefreshing"><div class="stopRefreshing">Stop refreshing</div><div class="startRefreshing" style="display: none">Start Refreshing</div></div>
  </body>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
  let MODE = {'SELECT': 1, 'DISPLAY': 2};
  
  class Global {
    static getElt() {
      return $('.global');
    }
  
    static getAttr(attrName) {
      return Global.getElt().attr(attrName);
    }
  
    static setAttr(attrName, value) {
      Global.getElt().attr(attrName, value);
    }
    
    static getSheetName() {
      return Global.getAttr('data-sheet-name');
    }
  
    static setSheetName(name) {
      return Global.setAttr('data-sheet-name', name);
    }
  
    static getSheetId() {
      return Global.getAttr('data-sheet-id');
    }
  
    static setSheetId(sheetId) {
      return Global.setAttr('data-sheet-id', sheetId);
    }

    static getIsTracked() {
      return Global.getAttr('data-is-tracked');
    }
    
    static setIsTracked(tracked) {
      Global.setAttr('data-is-tracked', String(tracked));
    }
    
    static getLabel() {
      return Global.getAttr('data-label-name');
    }
    
    static setLabel(label) {
      return Global.setAttr('data-label-name', label);
    }
    
    static getMaxThreads() {
      return Global.getAttr('data-max-threads');
    }
    
    static setMaxThreads(maxThreads) {
      return Global.setAttr('data-max-threads', maxThreads);
    }
    
    static clearLabel() {
      Global.setLabel(null);
    }

    static showMessage(msg) {
      Global.clearError();
      $('.message').text(msg);
    }

    static clearMessage() {
      if ($('.message').text() !== '') {
        Global.showMessage('');
      }
    }

    static showError(msg) {
      if (msg.startsWith('NetworkError: Connection failure due to HTTP ')) {
        Global.log(msg);
        return;
      }
      Global.clearMessage();
      $('.error').text(msg);
    }

    static clearError(msg) {
      if ($('.error').text() !== '') {
        Global.showError('');
      }
    }
    
    static log(msg) {
      console.log(msg);
    }
  }
  
  class RpcConfig {
    constructor(callFn) {
      this.callFn = callFn;
      this.handleSuccess_ = Global.log;
      this.handleFailure_ = Global.log;
    }
    
    retryOnTimeout() {
      if (!RpcConfig.ALLOW_RETRIES) {
        return this;
      }
      return this.withFailureHandler(function(errorMsg) {
            if (errorMsg === 'ScriptError: Exceeded maximum execution time') {
              console.log(errorMsg);
              this.callRpc();
              return;
              Global.showError(errorMsg);
            }
          }.bind(this));
    }
    
    withSuccessHandler(handleSuccess) {
      this.handleSuccess_ = handleSuccess;
      return this;
    }
    
    withFailureHandler(handleFailure) {
      this.handleFailure_ = handleFailure;
      return this;
    }
    
    callRpc() {
      this.callFn(google.script.run.withSuccessHandler(this.handleSuccess_).withFailureHandler(this.handleFailure_));
    }
  }
  
  RpcConfig.ALLOW_RETRIES = false;
  
  class AlternatingVisibility {
    constructor(name) {
      this.name = name;
      this.jqMap = {};
    }
    
    map(key, jqs) {
      this.jqMap[String(key)] = jqs;
      return this;
    }
    
    setVisible(visibleKey) {
      console.log('For ' + this.name);
      console.log('setVisible(' + visibleKey + ')');
      visibleKey = String(visibleKey);
      if (!this.jqMap[visibleKey]) {
        throw new Error('Invalid key: ' + visibleKey);
      }
      let keys = Object.keys(this.jqMap);
      for (let i = 0; i < keys.length; i++) {
        let key = keys[i];
        let jq = this.jqMap[key];
        if (visibleKey === key) {
          jq.show();
        } else {
          jq.hide();
        }
      }
    }
  }
  
  class LabelPicker {
    static getSelectElement() {
      return $('.labelSelect');
    }

    static getMaxThreadsElement() {
      return $('.maxThreads');
    }

    static clearSelectOptions(initialOptionText) {
      LabelPicker.getSelectElement().find('option').remove();
      LabelPicker.getSelectElement().append($('<option />').text(initialOptionText));
    }
    
    static populateSelect(labels) {
      LabelPicker.clearSelectOptions('Select Label');
      let currLabel = Global.getLabel();
      labels.sort();
      for (let i = 0; i < labels.length; i++) {
        let label = labels[i];
        let newOption = $('<option />').val(label).text(label);
        LabelPicker.getSelectElement().append(newOption)
        if (currLabel == label) {
          newOption.prop('selected', true);
        }
      }
    }

    static getLabelNameElt() {
      return $('.labelName');
    }
  
    static setMode(mode) {
      if (mode == MODE.SELECT) {
        LabelPicker.DISPLAY_MODE_VISIBILITY.setVisible(MODE.SELECT)
      } else if (mode == MODE.DISPLAY) {
        LabelPicker.DISPLAY_MODE_VISIBILITY.setVisible(MODE.DISPLAY)
        let labelName = Global.getLabel();
        LabelPicker.getLabelNameElt().text(labelName ? (labelName + ' (' + Global.getMaxThreads() + ' max)') : 'Choose label...');
        LabelPicker.LABEL_BUTTON_VISIBILITY.setVisible(!!labelName);
      } else {
        throw new Error('Unexpected mode: ' + mode);
      }
    }
    
    static updateLabelFromSelect() {
      let ret = LabelPicker.getSelectElement().val();
      Global.setLabel(ret);
      Global.setMaxThreads(LabelPicker.getMaxThreadsElement().val());
      return ret;
    }
    
    static updateMaxThreadsFromInput() {
      let ret = LabelPicker.getMaxThreadsElement().val();
      Global.setMaxThreads(ret);
      return ret;
    }
    
    static renameLabel(newLabel) {
      Global.showMessage('Renaming label ' + Global.getLabel() + ' to ' + newLabel);
      new RpcConfig(runner => runner.renameLabel(Global.getSheetId(), newLabel)).
          withSuccessHandler(Global.showMessage).
          callRpc();
      Global.setLabel(newLabel);
      LabelPicker.setMode(MODE.DISPLAY);
    }
  }
  
  LabelPicker.DISPLAY_MODE_VISIBILITY = new AlternatingVisibility('DisplayMode').
      map(MODE.SELECT, $('.labelSelectMode')).
      map(MODE.DISPLAY, $('.labelDisplayMode'));
  
  LabelPicker.LABEL_BUTTON_VISIBILITY = new AlternatingVisibility('LabelButton').
      map(true, $('.removeLabelButton,.syncWithGmailButton,.renameLabelButton')).
      map(false, $('.noButtonExisting'));
  
  class Gmail {
    static populateLabelSelect() {
      LabelPicker.clearSelectOptions('Populating...');
      LabelPicker.getMaxThreadsElement().val(Global.getMaxThreads());
      new RpcConfig(runner => runner.getAllLabels()).
          retryOnTimeout().
          withSuccessHandler(successMsg => LabelPicker.populateSelect(JSON.parse(successMsg))).
          callRpc();
    }
  }
  
  class SheetController {
    static setTracked(tracked) {
      Global.setIsTracked(tracked);
      new RpcConfig(runner => runner.setTrackedForSheet(Global.getSheetId(), tracked)).
          retryOnTimeout().
          callRpc();
    }
    
    static getSheetNameElt() {
      return $('.sheetName');
    }
    
    static hide() {
      $('.sheetController').hide();
    }
    
    static labelNameClicked() {
      Gmail.populateLabelSelect();
      LabelPicker.setMode(MODE.SELECT);
    }
    
    static show() {
      SheetController.getSheetNameElt().text(Global.getSheetName());
      SheetController.TRACKED_VISIBILITY.setVisible(Global.getIsTracked());
      LabelPicker.setMode(MODE.DISPLAY);
      $('.sheetController').show();
    }
    
    static trackClicked() {
      SheetController.setTracked(true);
      SheetController.show();
    }

    static init() {
      console.log('init()');
      SheetController.show();
    }

    static organizeClicked() {
      Global.showMessage('Organizing ' + Global.getSheetName() + ' sheet...');
      new RpcConfig(runner => runner.organize(Global.getSheetId())).
          retryOnTimeout().
          withSuccessHandler(Global.showMessage).
          callRpc();
    }
    
    static cancelLabelClicked() {
      LabelPicker.setMode(MODE.DISPLAY);
    }
    
    static saveClicked() {
      new RpcConfig(runner => runner.setLabelForSheet(Global.getSheetId(), LabelPicker.updateLabelFromSelect(), LabelPicker.updateMaxThreadsFromInput())).
          retryOnTimeout().
          callRpc();
      LabelPicker.setMode(MODE.DISPLAY);
    }
    
    static removeLabelClicked() {
      Global.clearLabel();
      new RpcConfig(runner => runner.clearLabelForSheet(Global.getSheetId())).callRpc();
      LabelPicker.setMode(MODE.DISPLAY);
    }

    static syncWithGmailClicked() {
      Global.showMessage('Syncing ' + Global.getSheetName() + ' sheet with ' + Global.getLabel() + ' label...');
      Global.clearError();
      new RpcConfig(runner => runner.syncSheetWithGmail(Global.getSheetId())).
          retryOnTimeout().
          withSuccessHandler(Global.showMessage).
          callRpc();
    }

    static syncAllWithGmailClicked() {
      Global.showMessage('Syncing all...');
      Global.clearError();
      new RpcConfig(runner => runner.syncSheetWithGmail(Global.getSheetId())).
          retryOnTimeout().
          withSuccessHandler(Global.showMessage).
          callRpc();
    }

    static renameLabelClicked() {
      let newLabel = window.prompt('New label name?');
      if (newLabel) {
        LabelPicker.renameLabel(newLabel);
      }
    }
    
    static addListeners() {
      $('.labelName').click(SheetController.labelNameClicked);
      $('.trackButton').click(SheetController.trackClicked);
      $('.renameLabelButton').click(SheetController.renameLabelClicked);
      $('.removeLabelButton').click(SheetController.removeLabelClicked);
      $('.cancelLabelButton').click(SheetController.cancelLabelClicked);
      $('.saveButton').click(SheetController.saveClicked);
      $('.syncWithGmailButton').click(SheetController.syncWithGmailClicked);
      $('.organizeButton').click(SheetController.organizeClicked);
    }
    
    static checkActiveSheetId() {
      if (!SheetController.refresh) {
        return;
      }
      function getActiveSheetIdSuccessHandler(activeSheetId) {
        if (activeSheetId != Global.getSheetId()) {
          SheetController.hide();
          function preferencesSuccessHandler(preferencesStr) {
            let preferences = JSON.parse(preferencesStr);
            Global.setSheetId(activeSheetId);
            Global.setSheetName(preferences.sheetName);
            Global.setIsTracked(preferences.isTracked);
            Global.setLabel(preferences.label);
            SheetController.show();
          }
          new RpcConfig(runner => runner.getPreferencesForSheet(activeSheetId)).
              retryOnTimeout().
              withSuccessHandler(preferencesSuccessHandler).
              callRpc();
        }
      }
      new RpcConfig(runner => runner.getActiveSheetId()).
          retryOnTimeout().
          withSuccessHandler(getActiveSheetIdSuccessHandler).
          callRpc();
    }
    
    static toggleRefreshing() {
      SheetController.refresh = !SheetController.refresh;
      SheetController.REFRESH_VISIBILITY.setVisible(SheetController.refresh);
    }
    
    static init() {
      SheetController.addListeners();
      SheetController.show();
      window.setInterval(SheetController.checkActiveSheetId, 1000);
    }
  }
  
  SheetController.refresh = true;
  
  SheetController.TRACKED_VISIBILITY = new AlternatingVisibility('Tracked').
      map(true, $('.tracked')).
      map(false, $('.untracked'));
  SheetController.REFRESH_VISIBILITY = new AlternatingVisibility('Refresh').
      map(true, $('.stopRefreshing')).
      map(false, $('.startRefreshing'));
  
  class GlobalController {
    static organizeAllClicked() {
      Global.showMessage('Organizing all...');
      Global.clearError();
      new RpcConfig(runner => runner.organizell()).
          retryOnTimeout().
          withSuccessHandler(Global.showMessage).
          callRpc();
    }

    static updateOverviewClicked() {
      Global.showMessage('Updating overview...');
      Global.clearError();
      new RpcConfig(runner => runner.updateOverview()).
          retryOnTimeout().
          withSuccessHandler(Global.showMessage).
          callRpc();
    }

    static doAllTheThingsClicked() {
      Global.showMessage('Doing all the things...');
      Global.clearError();
      new RpcConfig(runner => runner.doAllTheThings()).
          retryOnTimeout().
          withSuccessHandler(Global.showMessage).
          callRpc();
    }
    
    static toggleRefreshingClicked() {
      SheetController.toggleRefreshing();
    }

    static addListeners() {
      $('.syncAllWithGmailButton').click(GlobalController.syncAllWithGmailClicked);
      $('.organizeAllButton').click(GlobalController.organizeAllClicked);
      $('.updateOverviewButton').click(GlobalController.updateOverviewClicked);
      $('.doAllTheThingsButton').click(GlobalController.doAllTheThingsClicked);
      $('.toggleRefreshing').click(GlobalController.toggleRefreshingClicked);
    }
    
    static init() {
      GlobalController.addListeners();
    }
  }
  
  SheetController.init();
  GlobalController.init();
  
  </script>
</html>
