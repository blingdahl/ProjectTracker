<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <style>
      h1 {
        font-family: sans-serif;
        font-size: 13px;
      }
      
      div {
        font-family: sans-serif;
      }
      
      error {
        color: red;
      }
    </style>
    <h1 data-sheet-id="<?= sheetId ?>" data-is-tracked="<?= isTracked ?>">Preferences for <?= sheetName ?></h1>
    <div class="untracked" style="display: none">
      <button class="trackButton">Track sheet</button>
    </div>
    <div class="tracked" style="display: none">
      <div class="labelPicker">
        <div class="labelDisplayMode" style="display: none">
          <span class="labelName" data-label-name="<?= label ?>"></span>
          <button class="chooseLabelButton">Choose...</button>
          <button class="removeLabelButton">Remove</button>
        </div>
        <div class="labelSelectMode" style="display: none">
          <select class="labelSelect">
          </select>
          <button class="selectLabelButton">Select</button>
          <button class="cancelLabelButton">Cancel</button>
        </div>
      </div>
      <button class="syncWithGmailButton">Sync with Gmail</button>
      <button class="organizeButton">Organize</button>
    </div>
    <div class="message"></div>
    <div class="error"></div>
  </body>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
  let MODE = {'SELECT': 1, 'DISPLAY': 2};
  
  class AlternatingVisibility {
    constructor() {
      this.jqMap = {};
    }
    
    map(key, jqs) {
      this.jqMap[String(key)] = jqs;
      return this;
    }
    
    setVisible(visibleKey) {
      visibleKey = String(visibleKey);
      if (!this.jqMap[visibleKey]) {
        throw new Error('Invalid key: ' + visibleKey);
      }
      let keys = Object.keys(this.jqMap);
      for (let i = 0; i < keys.length; i++) {
        let key = keys[i];
        let jq = this.jqMap[key];
        if (visibleKey === key) {
          jq.show();
        } else {
          jq.hide();
        }
      }
    }
  }
  
  class LabelPicker {
    static getSelectElement() {
      return $('.labelSelect');
    }

    static clearSelectOptions(initialOptionText) {
      LabelPicker.getSelectElement().find('option').remove();
      LabelPicker.getSelectElement().append($('<option />').text(initialOptionText));
    }
    
    static populateSelect(labels) {
      LabelPicker.clearSelectOptions('Select Label');
      let currLabel = LabelPicker.getCurrLabel();
      labels.sort();
      for (let i = 0; i < labels.length; i++) {
        let label = labels[i];
        let newOption = $('<option />').val(label).text(label);
        LabelPicker.getSelectElement().append(newOption)
        if (currLabel == label) {
          newOption.prop('selected', true);
        }
      }
    }

    static getLabelNameElt() {
      return $('.labelName');
    }
    
    static getCurrLabel() {
      return Preferences.getGlobalAttr('data-label-name');
    }
    
    static setCurrLabel(label) {
      return Preferences.setGlobalAttr('data-label-name', label);
    }
  
    static setMode(mode) {
      if (mode == MODE.SELECT) {
        LabelPicker.DISPLAY_MODE_VISIBILITY.setVisible(MODE.SELECT)
      } else if (mode == MODE.DISPLAY) {
        LabelPicker.DISPLAY_MODE_VISIBILITY.setVisible(MODE.DISPLAY)
        let labelName = this.getCurrLabel();
        $('.labelName').text(labelName || 'No label');
        if (labelName) {
          $('.removeLabelButton').show();
          $('.syncWithGmailButton').show();
        } else {
          $('.removeLabelButton').hide();
          $('.syncWithGmailButton').hide();
        }
      } else {
        throw new Error('Unexpected mode: ' + mode);
      }
    }
    
    static updateCurrLabelFromSelect() {
      let ret = LabelPicker.getSelectElement().val();
      LabelPicker.setCurrLabel(ret);
      return ret;
    }
    
    static clearCurrLabel() {
      LabelPicker.setCurrLabel(null);
    }
  }
  
  LabelPicker.DISPLAY_MODE_VISIBILITY = new AlternatingVisibility().
      map(MODE.SELECT, $('.labelSelectMode')).
      map(MODE.DISPLAY, $('.labelDisplayMode'));
  
  class Gmail {
    static populateLabelSelect() {
      LabelPicker.clearSelectOptions('Populating...');
      google.script.run.withSuccessHandler(function(labels) {
        LabelPicker.populateSelect(JSON.parse(labels));
      }).getAllLabels();
    }
    
    static chooseLabelClicked() {
      Gmail.populateLabelSelect();
      LabelPicker.setMode(MODE.SELECT);
    }
    
    static removeLabelClicked() {
      LabelPicker.clearCurrLabel();
      google.script.run.clearLabelForSheet(Preferences.getSheetId());
      LabelPicker.setMode(MODE.DISPLAY);
    }
    
    static cancelLabelClicked() {
      LabelPicker.setMode(MODE.DISPLAY);
    }
    
    static selectLabelClicked() {
      google.script.run.setLabelForSheet(Preferences.getSheetId(), LabelPicker.updateCurrLabelFromSelect());
      LabelPicker.setMode(MODE.DISPLAY);
    }

    static syncWithGmailClicked() {
      Preferences.setMessage('Syncing...');
      Preferences.setError('');
      google.script.run.withSuccessHandler(Preferences.setMessage).withFailureHandler(Preferences.handleFailure).syncSheetWithGmail(Preferences.getSheetId());
    }
    
    static addListeners() {
      $('.chooseLabelButton').click(Gmail.chooseLabelClicked);
      $('.removeLabelButton').click(Gmail.removeLabelClicked);
      $('.cancelLabelButton').click(Gmail.cancelLabelClicked);
      $('.selectLabelButton').click(Gmail.selectLabelClicked);
      $('.syncWithGmailButton').click(Gmail.syncWithGmailClicked);
    }
  }
  
  class Preferences {
    static getGlobalAttr(attrName) {
      return $('[' + attrName + ']').attr(attrName);
    }
  
    static setGlobalAttr(attrName, value) {
      $('[' + attrName + ']').attr(attrName, value);
    }
  
    static getSheetId() {
      return Preferences.getGlobalAttr('data-sheet-id');
    }

    static isTracked() {
      return Preferences.getGlobalAttr('data-is-tracked');
    }
    
    static setTracked(tracked) {
      Preferences.setGlobalAttr('data-is-tracked', String(tracked));
      google.script.run.setTrackedForSheet(Preferences.getSheetId(), tracked);
    }
    
    static updateVisibilities() {
      Preferences.TRACKED_VISIBILITY.setVisible(Preferences.isTracked());
      LabelPicker.setMode(MODE.DISPLAY);
    }
    
    static trackClicked() {
      Preferences.setTracked(true);
      Preferences.updateVisibilities();
    }

    static init() {
      Preferences.updateVisibilities();
    }

    static setMessage(msg) {
      $('.message').text(msg);
    }

    static setError(msg) {
      $('.error').text(msg);
    }

    static handleFailure(msg) {
      Preferences.setError(msg);
    }

    static organizedClicked() {
      Preferences.setMessage('Organizing...');
      Preferences.setError('');
      google.script.run.withSuccessHandler(Preferences.setMessage).withFailureHandler(Preferences.handleFailure).syncSheetWithGmail(Preferences.getSheetId());
    }
    
    static addListeners() {
      $('.trackButton').click(Preferences.trackClicked);
      $('.organizeButton').click(Preferences.organizeClicked);
      Gmail.addListeners();
    }
  }
  
  
  Preferences.TRACKED_VISIBILITY = new AlternatingVisibility().
      map(true, $('.tracked')).
      map(false, $('.untracked'));
  
  Preferences.currSheetId = null;
  
  Preferences.addListeners();
  Preferences.init();
  
  </script>
</html>
