<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <style>
      h1 {
        font-family: sans-serif;
        font-size: 13px;
      }
      
      div {
        font-family: sans-serif;
      }
      
      error {
        color: red;
      }
    </style>
    <h1 data-sheet-id="<?= sheetId ?>" data-is-tracked="<?= isTracked ?>">Preferences for <span data-sheet-name="<?= sheetName ?>"></span></h1>
    <div class="untracked" style="display: none">
      <button class="trackButton">Track sheet</button>
    </div>
    <div class="tracked" style="display: none">
      <div class="labelPicker">
        <div class="labelDisplayMode" style="display: none">
          <span class="labelName" data-label-name="<?= label ?>"></span>
          <button class="chooseLabelButton">Choose...</button>
          <button class="removeLabelButton">Remove</button>
        </div>
        <div class="labelSelectMode" style="display: none">
          <select class="labelSelect">
          </select>
          <button class="selectLabelButton">Select</button>
          <button class="cancelLabelButton">Cancel</button>
        </div>
      </div>
      <button class="syncWithGmailButton">Sync with Gmail</button>
      <button class="organizeButton">Organize</button>
      <button class="testButton" style="display: none">Test</button>
    </div>
    <div class="message"></div>
    <div class="error"></div>
  </body>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
  let MODE = {'SELECT': 1, 'DISPLAY': 2};
  
  class Global {
    static getElt(attrName) {
      return $('[' + attrName + ']');
    }
  
    static getAttr(attrName) {
      return Global.getElt(attrName).attr(attrName);
    }
  
    static setAttr(attrName, value) {
      Global.getElt(attrName).attr(attrName, value);
    }
    
    static getSheetNameElt() {
      return Global.getElt('data-sheet-name');
    }
    
    static getSheetName() {
      return Global.getAttr('data-sheet-name');
    }
  
    static setSheetName(name) {
      return Global.setAttr('data-sheet-name', name);
    }
  
    static getSheetId() {
      return Global.getAttr('data-sheet-id');
    }
  
    static setSheetId(sheetId) {
      return Global.setAttr('data-sheet-id', sheetId);
    }

    static getIsTracked() {
      return Global.getAttr('data-is-tracked');
    }
    
    static setIsTracked(tracked) {
      Global.setAttr('data-is-tracked', String(tracked));
    }
    
    static getCurrLabel() {
      return Global.getAttr('data-label-name');
    }
    
    static setCurrLabel(label) {
      return Global.setAttr('data-label-name', label);
    }
    
    static clearCurrLabel() {
      Global.setCurrLabel(null);
    }

    static setMessage(msg) {
      Global.clearError();
      $('.message').text(msg);
    }

    static clearMessage() {
      if ($('.message').text() !== '') {
        Global.setMessage('');
      }
    }

    static setError(msg) {
      Global.clearMessage();
      $('.error').text(msg);
    }

    static clearError(msg) {
      if ($('.error').text() !== '') {
        Global.setError('');
      }
    }
  }
  
  class AlternatingVisibility {
    constructor() {
      this.jqMap = {};
    }
    
    map(key, jqs) {
      this.jqMap[String(key)] = jqs;
      return this;
    }
    
    setVisible(visibleKey) {
      visibleKey = String(visibleKey);
      if (!this.jqMap[visibleKey]) {
        throw new Error('Invalid key: ' + visibleKey);
      }
      let keys = Object.keys(this.jqMap);
      for (let i = 0; i < keys.length; i++) {
        let key = keys[i];
        let jq = this.jqMap[key];
        if (visibleKey === key) {
          jq.show();
        } else {
          jq.hide();
        }
      }
    }
  }
  
  class LabelPicker {
    static getSelectElement() {
      return $('.labelSelect');
    }

    static clearSelectOptions(initialOptionText) {
      LabelPicker.getSelectElement().find('option').remove();
      LabelPicker.getSelectElement().append($('<option />').text(initialOptionText));
    }
    
    static populateSelect(labels) {
      LabelPicker.clearSelectOptions('Select Label');
      let currLabel = Global.getCurrLabel();
      labels.sort();
      for (let i = 0; i < labels.length; i++) {
        let label = labels[i];
        let newOption = $('<option />').val(label).text(label);
        LabelPicker.getSelectElement().append(newOption)
        if (currLabel == label) {
          newOption.prop('selected', true);
        }
      }
    }

    static getLabelNameElt() {
      return $('.labelName');
    }
  
    static setMode(mode) {
      if (mode == MODE.SELECT) {
        LabelPicker.DISPLAY_MODE_VISIBILITY.setVisible(MODE.SELECT)
      } else if (mode == MODE.DISPLAY) {
        LabelPicker.DISPLAY_MODE_VISIBILITY.setVisible(MODE.DISPLAY)
        let labelName = Global.getCurrLabel();
        $('.labelName').text(labelName || 'No label');
        if (labelName) {
          $('.removeLabelButton').show();
          $('.syncWithGmailButton').show();
        } else {
          $('.removeLabelButton').hide();
          $('.syncWithGmailButton').hide();
        }
      } else {
        throw new Error('Unexpected mode: ' + mode);
      }
    }
    
    static updateCurrLabelFromSelect() {
      let ret = LabelPicker.getSelectElement().val();
      Global.setCurrLabel(ret);
      return ret;
    }
  }
  
  LabelPicker.DISPLAY_MODE_VISIBILITY = new AlternatingVisibility().
      map(MODE.SELECT, $('.labelSelectMode')).
      map(MODE.DISPLAY, $('.labelDisplayMode'));
  
  class Gmail {
    static populateLabelSelect() {
      LabelPicker.clearSelectOptions('Populating...');
      google.script.run.withSuccessHandler(function(labels) {
        LabelPicker.populateSelect(JSON.parse(labels));
      }).getAllLabels();
    }
    
    static chooseLabelClicked() {
      Gmail.populateLabelSelect();
      LabelPicker.setMode(MODE.SELECT);
    }
    
    static removeLabelClicked() {
      Global.clearCurrLabel();
      google.script.run.clearLabelForSheet(Global.getSheetId());
      LabelPicker.setMode(MODE.DISPLAY);
    }
    
    static cancelLabelClicked() {
      LabelPicker.setMode(MODE.DISPLAY);
    }
    
    static selectLabelClicked() {
      google.script.run.setLabelForSheet(Global.getSheetId(), LabelPicker.updateCurrLabelFromSelect());
      LabelPicker.setMode(MODE.DISPLAY);
    }

    static syncWithGmailClicked() {
      Global.setMessage('Syncing...');
      Global.clearError();
      google.script.run.withSuccessHandler(Global.setMessage).withFailureHandler(Global.setError).syncSheetWithGmail(Global.getSheetId());
    }
    
    static addListeners() {
      $('.chooseLabelButton').click(Gmail.chooseLabelClicked);
      $('.removeLabelButton').click(Gmail.removeLabelClicked);
      $('.cancelLabelButton').click(Gmail.cancelLabelClicked);
      $('.selectLabelButton').click(Gmail.selectLabelClicked);
      $('.syncWithGmailButton').click(Gmail.syncWithGmailClicked);
    }
  }
  
  class Preferences {
    static setTracked(tracked) {
      Global.setIsTracked(tracked);
      google.script.run.setTrackedForSheet(Global.getSheetId(), tracked);
    }
    
    static updateVisibilities() {
      Global.getSheetNameElt().text(Global.getSheetName());
      Preferences.TRACKED_VISIBILITY.setVisible(Global.getIsTracked());
      LabelPicker.setMode(MODE.DISPLAY);
      Global.clearMessage();
      Global.clearError();
    }
    
    static trackClicked() {
      Preferences.setTracked(true);
      Preferences.updateVisibilities();
    }

    static init() {
      Preferences.updateVisibilities();
    }

    static organizeClicked() {
      Global.setMessage('Organizing...');
      Global.clearError();
      google.script.run.withSuccessHandler(Global.setMessage).withFailureHandler(Global.setError).organizeTracking(Preferences.getSheetId());
    }

    static testClicked() {
      Global.setMessage('Testing...');
      Global.clearError();
      google.script.run.withSuccessHandler(Global.setMessage).withFailureHandler(Global.setError).getActiveSheetId();
    }
    
    static addListeners() {
      $('.trackButton').click(Preferences.trackClicked);
      $('.organizeButton').click(Preferences.organizeClicked);
      $('.testButton').click(Preferences.testClicked);
      Gmail.addListeners();
    }
    
    static checkActiveSheetId() {
      function getActiveSheetIdSuccessHandler(activeSheetId) {
        if (activeSheetId != Global.getSheetId()) {
          Global.setMessage('Getting sheet preferences');
          function preferencesSuccessHandler(preferencesStr) {
            console.log(preferencesStr);
            let preferences = JSON.parse(preferencesStr);
            Global.setSheetId(activeSheetId);
            Global.setSheetName(preferences.sheetName);
            Global.setIsTracked(preferences.isTracked);
            Global.setCurrLabel(preferences.label);
            Preferences.updateVisibilities();
          }
          google.script.run.withSuccessHandler(preferencesSuccessHandler).withFailureHandler(Global.setError).getPreferencesForSheet(activeSheetId);
        }
      }
      google.script.run.withSuccessHandler(getActiveSheetIdSuccessHandler).withFailureHandler(Global.setError).getActiveSheetId();
    }
  }
  
  Preferences.TRACKED_VISIBILITY = new AlternatingVisibility().
      map(true, $('.tracked')).
      map(false, $('.untracked'));
  
  Preferences.currSheetId = null;

  Preferences.addListeners();
  Preferences.init();
  window.setInterval(Preferences.checkActiveSheetId, 1000);
  
  </script>
</html>
